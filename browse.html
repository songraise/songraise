<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Browse Campaigns â€” SongRaise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="shell.css">

  <style>
    :root{
      --bg1:#f7fbff;
      --bg2:#f2f0ff;
      --bg3:#fff7ea;

      --ink:#14162b;
      --muted:#5c617a;
      --muted2:#7b8098;

      --card:#ffffff;
      --border:#e7e8f3;
      --shadow: 0 18px 60px rgba(20,22,43,.12);

      --brand:#5b49ff;
      --brand2:#2ec9a2;

      --cta:#ffd34d;
      --cta2:#ffbf2f;
      --ctaInk:#2b240a;

      --radius:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:var(--font);
      color:var(--ink);
      line-height:1.55;
      background:
        radial-gradient(1100px 520px at 50% 0%, rgba(91,73,255,.18), transparent 60%),
        radial-gradient(900px 520px at 20% 10%, rgba(46,201,162,.12), transparent 55%),
        radial-gradient(900px 520px at 85% 20%, rgba(255,211,77,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
      overflow-x:hidden;
    }

    /* Subtle floating notes */
    .notes{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .note{
      position:absolute;
      font-size:26px;
      opacity:.16;
      filter: blur(.2px);
      animation: floaty 7.8s ease-in-out infinite;
      user-select:none;
    }
    .note:nth-child(1){left:7%; top:18%; animation-duration:8.6s}
    .note:nth-child(2){left:89%; top:20%; font-size:30px; opacity:.13; animation-duration:9.6s}
    .note:nth-child(3){left:78%; top:58%; font-size:24px; opacity:.12; animation-duration:7.9s}
    .note:nth-child(4){left:10%; top:72%; font-size:22px; opacity:.10; animation-duration:9.2s}
    .note:nth-child(5){left:55%; top:7%; font-size:20px; opacity:.10; animation-duration:10.4s}
    @keyframes floaty{
      0%{transform: translateY(0px) rotate(-2deg)}
      50%{transform: translateY(-10px) rotate(2deg)}
      100%{transform: translateY(0px) rotate(-2deg)}
    }

    .sr-wrap{position:relative; z-index:1;}
    .sr-page{position:relative; z-index:1;}

    .wrap{max-width:1140px;margin:0 auto;padding:18px 14px 90px}

    /* Topbar */
    .top{
      position:sticky;top:0;z-index:50;
      background: rgba(255,255,255,.74);
      border:1px solid rgba(231,232,243,.90);
      border-radius:999px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 28px rgba(20,22,43,.07);
    }

    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:1.12rem;
      letter-spacing:-.02em
    }
    .mark{
      width:30px;height:30px;border-radius:10px;
      background: linear-gradient(135deg, rgba(91,73,255,.95), rgba(46,201,162,.72));
      display:inline-flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(91,73,255,.18);
      flex:0 0 auto;
    }
    .mark svg{width:18px;height:18px;fill:#fff}
    .logo span.small{
      font-size:.78rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(231,232,243,.95);
      background: rgba(255,255,255,.86);
      color: rgba(20,22,43,.70);
      font-weight:900;
    }

    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .btn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(231,232,243,.95);
      background: rgba(255,255,255,.88);
      cursor:pointer;
      font-weight:900;
      text-decoration:none;
      color:var(--ink);
      display:inline-block;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:#fff}
    .btn:active{transform: translateY(1px)}

    .btn-primary{
      background: linear-gradient(180deg, var(--cta) 0%, var(--cta2) 100%);
      border-color: rgba(255,191,47,.55);
      color: var(--ctaInk);
      box-shadow: 0 16px 40px rgba(255,191,47,.22);
    }

    h1{font-size:2.0rem;letter-spacing:-.02em;margin:16px 0 6px}
    .lead{color:var(--muted);max-width:980px;font-weight:650}

    .card{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(231,232,243,.95);
      border-radius:18px;
      padding:14px 14px;
      box-shadow: var(--shadow);
      margin-top:14px;
      backdrop-filter: blur(10px);
    }

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .controls input, .controls select{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(231,232,243,.95);
      background: rgba(255,255,255,.92);
      min-width:240px;
      outline:none;
    }
    .controls input:focus, .controls select:focus{
      border-color: rgba(91,73,255,.45);
      box-shadow: 0 0 0 4px rgba(91,73,255,.12);
    }

    .pill{
      font-size:.9rem;font-weight:900;color:rgba(20,22,43,.78);
      padding:6px 10px;border:1px solid rgba(231,232,243,.95);
      border-radius:999px;background:rgba(255,255,255,.86)
    }

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid rgba(231,232,243,.95);
      border-radius:14px;
      overflow:hidden;
      margin-top:12px;
      background: rgba(255,255,255,.92);
    }
    th,td{
      padding:10px;
      border-bottom:1px solid rgba(231,232,243,.95);
      text-align:left;
      font-size:.92rem;
      vertical-align:top
    }
    th{
      background: rgba(248,249,255,.95);
      font-size:.85rem;
      color:rgba(20,22,43,.78);
      font-weight:900
    }
    tr:last-child td{border-bottom:none}

    .muted{color:var(--muted2)}
    .mini{font-size:.86rem}

    .badge{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;
      border:1px solid rgba(231,232,243,.95);
      border-radius:999px;
      background: rgba(255,255,255,.86);
      font-weight:900;
      font-size:.86rem;
      color:rgba(20,22,43,.78)
    }

    .link{color:var(--brand);text-decoration:none;font-weight:900}
    .link:hover{text-decoration:underline}

    audio{width:240px;max-width:100%}
    @media(max-width:860px){ audio{width:100%} }

    .status{margin-top:10px;font-size:.92rem;color:var(--muted2)}
    .error{color:#b91c1c;font-weight:900}

    @media(max-width:680px){
      .controls input, .controls select{min-width:min(92vw, 420px);}
    }
  </style>
</head>

<body>
  <div class="notes" aria-hidden="true">
    <div class="note">ðŸŽµ</div>
    <div class="note">ðŸŽ¶</div>
    <div class="note">â™ª</div>
    <div class="note">â™«</div>
    <div class="note">ðŸŽ¼</div>
  </div>

  <div class="sr-wrap">
    <div id="sr-header"></div>
    <div class="sr-page">

      <div class="wrap">
        <div class="top">
          <div class="logo">
            <span class="mark" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M12 2c-2.6 0-4.7 2.1-4.7 4.7 0 2.1 1.4 3.9 3.3 4.5v8.8c0 1.2 1 2.2 2.2 2.2 1.2 0 2.2-1 2.2-2.2V11.2c1.9-.6 3.3-2.4 3.3-4.5C20.7 4.1 14.6 2 12 2z"/></svg>
            </span>
            <span>SongRaise</span>
            <span class="small">Browse</span>
          </div>

          <div class="nav">
            <a class="btn" href="index.html">Home</a>
            <a class="btn" href="how-it-works.html">How It Works</a>
            <a class="btn" href="dashboard.html">Dashboard / Login</a>
            <a class="btn btn-primary" href="browse.html">Browse Campaigns</a>
          </div>
        </div>

        <h1>Browse Campaigns</h1>
        <p class="lead">
          Explore public SongRaise campaigns. Listen, learn, and donate directly to the charity using the campaignâ€™s official donation link.
        </p>

        <div class="card">
          <div class="controls">
            <input id="q" placeholder="Search campaigns (title, cause, condition)â€¦" />
            <select id="filter">
              <option value="all">All public campaigns</option>
              <option value="ready">Only campaigns with songs</option>
            </select>
            <span class="pill" id="countPill">Loadingâ€¦</span>
          </div>

          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th style="min-width:240px;">Campaign</th>
                  <th style="min-width:220px;">Cause</th>
                  <th style="min-width:260px;">Listen</th>
                  <th style="min-width:160px;">Actions</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="status" id="statusLine"></div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <script>
        const SUPABASE_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmN4cGptZGZlcWpkbWNlbWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NzYsImV4cCI6MjA3NzE1Mzc3Nn0.LPRIt10bLZYfoOCx7nD4U0PsCURB7YToq4VbByliFi4";

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const rowsEl = document.getElementById("rows");
        const statusLine = document.getElementById("statusLine");
        const countPill = document.getElementById("countPill");
        const qEl = document.getElementById("q");
        const filterEl = document.getElementById("filter");

        function baseUrl(){
          const u = new URL(window.location.href);
          const basePath = u.pathname.endsWith("/") ? u.pathname : u.pathname.replace(/[^\/]+$/, "");
          return u.origin + basePath;
        }

        function escapeHtml(s){
          return String(s || "")
            .replaceAll("&","&amp;")
            .replaceAll("<","&lt;")
            .replaceAll(">","&gt;")
            .replaceAll('"',"&quot;")
            .replaceAll("'","&#039;");
        }

        function fmtDate(ts){
          if (!ts) return "";
          try { return new Date(ts).toLocaleDateString(); } catch(e){ return ""; }
        }

        function textIncludes(hay, needle){
          if (!needle) return true;
          return (hay || "").toLowerCase().includes(needle.toLowerCase());
        }

        async function fetchPublicCampaigns(){
          statusLine.className = "status";
          statusLine.textContent = "Loading campaignsâ€¦";
          rowsEl.innerHTML = "";
          countPill.textContent = "Loadingâ€¦";

          const { data, error } = await client
            .from("campaigns")
            .select(`
              id, title, description, donation_url, created_at, status, song_id,
              songs:song_id ( id, audio_url, cause_category, cause_condition, condition )
            `)
            .eq("status", "published")
            .order("created_at", { ascending: false })
            .limit(100);

          if (error){
            statusLine.classList.add("error");
            statusLine.textContent =
              "Could not load public campaigns. This usually means your Supabase RLS policies are blocking public SELECT. " +
              "Error: " + error.message;
            countPill.textContent = "0 campaigns";
            return [];
          }

          return data || [];
        }

        function render(list){
          const q = (qEl.value || "").trim().toLowerCase();
          const filter = filterEl.value;

          const filtered = list.filter(c => {
            const hasSong = !!c.song_id && !!(c.songs && c.songs.audio_url);
            if (filter === "ready" && !hasSong) return false;

            const cause = (c.songs?.cause_category || "") + " " + (c.songs?.cause_condition || c.songs?.condition || "");
            const hay = `${c.title || ""} ${cause} ${c.description || ""}`;
            return textIncludes(hay, q);
          });

          countPill.textContent = `${filtered.length} campaign${filtered.length === 1 ? "" : "s"}`;

          if (filtered.length === 0){
            rowsEl.innerHTML = `<tr><td colspan="4" class="muted">No campaigns match your search.</td></tr>`;
            statusLine.textContent = "";
            return;
          }

          const base = baseUrl();

          rowsEl.innerHTML = filtered.map(c => {
            const title = c.title || "(Untitled)";
            const created = fmtDate(c.created_at);
            const causeCat = c.songs?.cause_category || "";
            const causeCond = c.songs?.cause_condition || c.songs?.condition || "";
            const cause = (causeCat || causeCond) ? `${causeCat}${causeCat && causeCond ? " â€” " : ""}${causeCond}` : "â€”";

            const hasAudio = !!(c.songs && c.songs.audio_url);
            const audioHtml = hasAudio
              ? `<audio controls preload="metadata" src="${escapeHtml(c.songs.audio_url)}"></audio>`
              : `<span class="muted mini">Song in production</span>`;

            const viewUrl = `${base}campaign.html?id=${encodeURIComponent(c.id)}`;
            const donateUrl = c.donation_url ? escapeHtml(c.donation_url) : "";

            const donateHtml = donateUrl
              ? `<a class="link" href="${donateUrl}" target="_blank" rel="noopener noreferrer">Donate â†—</a>`
              : `<span class="muted mini">No donate link</span>`;

            return `
              <tr>
                <td>
                  <div style="font-weight:900;">${escapeHtml(title)}</div>
                  <div class="muted mini">${created ? "Created: " + created : ""}</div>
                  <div class="muted mini">${escapeHtml((c.description || "").slice(0, 110))}${(c.description || "").length > 110 ? "â€¦" : ""}</div>
                </td>
                <td>
                  <span class="badge">${escapeHtml(cause)}</span>
                </td>
                <td>${audioHtml}</td>
                <td>
                  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                    <a class="link" href="${viewUrl}">View</a>
                    ${donateHtml}
                  </div>
                </td>
              </tr>
            `;
          }).join("");

          statusLine.textContent = "";
        }

        let cached = [];

        async function init(){
          cached = await fetchPublicCampaigns();
          render(cached);
        }

        qEl.addEventListener("input", () => render(cached));
        filterEl.addEventListener("change", () => render(cached));

        init();
      </script>

    </div>
    <div id="sr-footer"></div>
  </div>

  <script defer src="shell.js"></script>
</body>
</html>
