<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SongRaiseLite ‚Äî Campaign</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared shell (already working for you) -->
  <link rel="stylesheet" href="shell.css">

  <style>
    /* Page-specific polish (safe + contained) */
    :root{
      --border:#e5e7eb;
      --muted:#6b7280;
      --text:#111827;
      --bg:#ffffff;
      --chip:#f9fafb;
      --primary:#2563eb;
      --danger:#b91c1c;
      --shadow: 0 10px 24px rgba(15,23,42,.06);
      --shadow2: 0 8px 18px rgba(15,23,42,.04);
    }

    .page { margin-top: 10px; }

    .card{
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow2);
    }

    .stack{ display: grid; gap: 12px; }

    .hero{
      padding: 18px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow2);
    }

    .kicker{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    h1{
      font-size: 1.9rem;
      letter-spacing: -0.02em;
      margin: 0 0 8px 0;
      line-height: 1.15;
    }

    .submeta{
      color: var(--muted);
      font-size: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill{
      font-size: 12.5px;
      font-weight: 800;
      color: #374151;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--chip);
    }
    .pill.primary{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.25);
      color: #1d4ed8;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items: center;
    }

    .btn{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      text-decoration: none;
      color: var(--text);
      display: inline-flex;
      gap: 8px;
      align-items: center;
      line-height: 1;
      user-select:none;
    }
    .btn:hover{ background:#f3f4f6; }
    .btn.primary{
      background: var(--primary);
      border-color: var(--primary);
      color:#fff;
    }
    .btn.primary:hover{ filter: brightness(0.95); }
    button.btn{ appearance:none; -webkit-appearance:none; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media(max-width: 920px){ .grid2{ grid-template-columns: 1fr; } h1{ font-size: 1.7rem; } }

    .box{
      padding: 12px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--chip);
    }

    .label{
      font-size: 12.5px;
      font-weight: 900;
      color:#374151;
      margin-bottom: 6px;
      letter-spacing: -0.01em;
    }

    .muted{ color: var(--muted); }
    .error{ color: var(--danger); font-weight: 900; }

    .link{
      color: var(--primary);
      text-decoration: none;
      font-weight: 900;
      word-break: break-word;
    }
    .link:hover{ text-decoration: underline; }

    .songCard{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow2);
    }

    audio{ width: 100%; margin-top: 8px; }
    img{ max-width: 100%; border-radius: 14px; border: 1px solid var(--border); background:#fff; }

    pre{
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size: .92rem;
      line-height: 1.5;
      margin: 0;
    }

    .stickyDonate{
      position: sticky;
      bottom: 12px;
      z-index: 30;
      margin-top: 14px;
    }
    @media(min-width: 921px){
      .stickyDonate{ position: static; bottom:auto; }
    }

    .stickyBar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      align-items: center;
      justify-content: space-between;
    }

    .leftMini{
      display:flex; flex-direction:column; gap:2px;
      min-width: 220px;
    }

    .tiny{ font-size: 12.5px; color: var(--muted); }

    /* loading row */
    .loadingRow{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: var(--shadow2);
    }
  </style>
</head>

<body>
  <div class="sr-wrap">
    <div id="sr-header"></div>

    <div class="sr-page page">
      <!-- Loading / error -->
      <div class="loadingRow" id="loadingRow">
        <div class="muted" id="loadingText">Loading‚Ä¶</div>

        <div id="errRow" style="display:none;margin-top:10px;">
          <div class="error" id="errText"></div>
        </div>
      </div>

      <!-- Main content -->
      <div id="content" style="display:none;">
        <!-- HERO -->
        <div class="hero">
          <div class="kicker">Campaign</div>

          <h1 id="campaignTitle"></h1>

          <div class="submeta">
            <span class="pill" id="campaignStatusPill" style="display:none;"></span>
            <span class="pill" id="authStatus">Checking login‚Ä¶</span>
            <span class="muted" id="campaignMeta"></span>
          </div>

          <div class="actions">
            <a class="btn" href="browse.html">‚Üê Browse</a>
            <a class="btn" href="dashboard.html">Dashboard</a>

            <button class="btn" type="button" id="copyLinkBtn">üîó Copy link</button>
            <button class="btn" type="button" id="shareBtn">üì£ Share</button>
          </div>

          <!-- Sticky donate bar (shows when donation URL exists) -->
          <div class="stickyDonate" id="stickyDonate" style="display:none;">
            <div class="stickyBar">
              <div class="leftMini">
                <div style="font-weight:900;">Support this campaign</div>
                <div class="tiny">Donations go to the listed charity (or its fundraising partner).</div>
              </div>
              <a class="btn primary" id="donateBtnTop" href="#" target="_blank" rel="noopener noreferrer">‚ù§Ô∏è Donate</a>
            </div>
          </div>
        </div>

        <div class="stack" style="margin-top:12px;">
          <!-- Overview boxes -->
          <div class="grid2">
            <div class="box" id="causeBox" style="display:none;">
              <div class="label">Cause</div>
              <div id="causeText"></div>
            </div>

            <div class="box" id="donBox" style="display:none;">
              <div class="label">Donation link</div>
              <a class="link" id="donationLink" href="#" target="_blank" rel="noopener noreferrer">Open donation page</a>
            </div>
          </div>

          <div class="box" id="descBox" style="display:none;">
            <div class="label">Campaign description</div>
            <div id="campaignDescription"></div>
          </div>

          <!-- Song -->
          <div class="songCard" id="songBox" style="display:none;">
            <div class="label">Song</div>
            <div class="muted" id="songMeta" style="margin-bottom:6px;"></div>

            <audio id="audio" controls playsinline webkit-playsinline style="display:none;"></audio>
            <div id="noAudio" class="muted" style="display:none;margin-top:8px;">
              No audio_url found for this song.
            </div>

            <div class="tiny" style="margin-top:10px;">
              Tip: If audio doesn‚Äôt play on mobile, ensure the MP3 is public and served as <strong>audio/mpeg</strong>.
            </div>
          </div>

          <!-- Cover + Lyrics -->
          <div class="grid2">
            <div class="card" id="coverBox" style="display:none;">
              <div class="label">Cover</div>
              <img id="coverImg" alt="Cover image" />
            </div>

            <div class="card" id="lyricsBox" style="display:none;">
              <div class="label">Lyrics</div>
              <pre id="lyrics"></pre>
            </div>
          </div>

          <!-- Trust block -->
          <div class="box">
            <div class="label">Transparency &amp; trust</div>
            <div class="muted">
              SongRaise is a campaign platform ‚Äî not a bank. Donations are directed to the listed charity (or its designated fundraising partner).
              SongRaise does not offer cash prizes, gambling, or speculative rewards.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="sr-footer"></div>
  </div>

  <script defer src="shell.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co";
    const SUPABASE_REF = "jvvcxpjmdfeqjdmcemet";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmN4cGptZGZlcWpkbWNlbWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NzYsImV4cCI6MjA3NzE1Mzc3Nn0.LPRIt10bLZYfoOCx7nD4U0PsCURB7YToq4VbByliFi4";

    const authStatusEl = document.getElementById("authStatus");
    const loadingRow = document.getElementById("loadingRow");
    const loadingText = document.getElementById("loadingText");
    const errRow = document.getElementById("errRow");
    const errText = document.getElementById("errText");
    const content = document.getElementById("content");

    const campaignTitle = document.getElementById("campaignTitle");
    const campaignMeta = document.getElementById("campaignMeta");
    const campaignStatusPill = document.getElementById("campaignStatusPill");

    const descBox = document.getElementById("descBox");
    const campaignDescription = document.getElementById("campaignDescription");

    const donBox = document.getElementById("donBox");
    const donationLink = document.getElementById("donationLink");
    const donateBtnTop = document.getElementById("donateBtnTop");
    const stickyDonate = document.getElementById("stickyDonate");

    const causeBox = document.getElementById("causeBox");
    const causeText = document.getElementById("causeText");

    const songBox = document.getElementById("songBox");
    const songMeta = document.getElementById("songMeta");
    const audioEl = document.getElementById("audio");
    const noAudio = document.getElementById("noAudio");

    const coverBox = document.getElementById("coverBox");
    const coverImg = document.getElementById("coverImg");
    const lyricsBox = document.getElementById("lyricsBox");
    const lyricsEl = document.getElementById("lyrics");

    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const shareBtn = document.getElementById("shareBtn");

    function showError(msg){
      errText.textContent = msg;
      errRow.style.display = "block";
      loadingText.textContent = "";
    }

    function decodeJwtPayload(jwt){
      try{
        const parts = jwt.split(".");
        if (parts.length < 2) return null;
        const b64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(atob(b64).split("").map(c => "%" + c.charCodeAt(0).toString(16).padStart(2,"0")).join(""));
        return JSON.parse(json);
      } catch(e){ return null; }
    }

    function storageKey(){ return `sb-${SUPABASE_REF}-auth-token`; }

    function getStoredSession(){
      const raw = localStorage.getItem(storageKey());
      if (!raw) return null;
      try { return JSON.parse(raw); } catch(e){ return null; }
    }

    async function refreshIfExpired(){
      const sess = getStoredSession();
      if (!sess?.access_token || !sess?.refresh_token) return;

      const payload = decodeJwtPayload(sess.access_token);
      const now = Math.floor(Date.now()/1000);
      if (!payload?.exp || payload.exp > (now + 60)) return;

      authStatusEl.textContent = "Refreshing‚Ä¶";
      const resp = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
        body: JSON.stringify({ refresh_token: sess.refresh_token })
      });

      if (!resp.ok){
        localStorage.removeItem(storageKey());
        return;
      }

      const data = await resp.json();
      if (data?.access_token && data?.refresh_token){
        const now2 = Math.floor(Date.now()/1000);
        const exp2 = now2 + Number(data.expires_in || 3600);
        localStorage.setItem(storageKey(), JSON.stringify({
          access_token: data.access_token,
          refresh_token: data.refresh_token,
          token_type: "bearer",
          expires_in: Math.max(0, exp2 - now2),
          expires_at: exp2,
          user: null
        }));
      }
    }

    function currentUserFromStorage(){
      const sess = getStoredSession();
      if (!sess?.access_token) return null;
      const p = decodeJwtPayload(sess.access_token);
      if (!p?.sub) return null;
      return { id: p.sub, email: p.email || "" };
    }

    function buildClient(){
      const sess = getStoredSession();
      const token = sess?.access_token || null;

      if (token){
        return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: window.localStorage },
          global: { headers: { Authorization: `Bearer ${token}` } }
        });
      }

      return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: window.localStorage }
      });
    }

    function getCampaignId(){
      const u = new URL(window.location.href);
      return u.searchParams.get("id");
    }

    function formatDate(dt){
      try { return new Date(dt).toLocaleString(); } catch(e){ return ""; }
    }

    async function copyCampaignLink(){
      const url = window.location.href;
      try{
        await navigator.clipboard.writeText(url);
        alert("Copied link:\n" + url);
      } catch(e){
        prompt("Copy this link:", url);
      }
    }

    async function shareCampaign(){
      const url = window.location.href;
      const title = campaignTitle.textContent || "SongRaise Campaign";
      const text = "Check out this fundraising campaign on SongRaise.";
      if (navigator.share){
        try{
          await navigator.share({ title, text, url });
        } catch(e){
          // user cancelled ‚Äî do nothing
        }
      } else {
        await copyCampaignLink();
      }
    }

    copyLinkBtn.addEventListener("click", (e) => { e.preventDefault(); copyCampaignLink(); });
    shareBtn.addEventListener("click", (e) => { e.preventDefault(); shareCampaign(); });

    async function load(){
      await refreshIfExpired();

      const user = currentUserFromStorage();
      authStatusEl.textContent = user ? "Logged in ‚úÖ" : "Logged out";

      const id = getCampaignId();
      if (!id){
        showError("Missing campaign id. Expected campaign.html?id=...");
        return;
      }

      const client = buildClient();

      const { data: c, error: cErr } = await client
        .from("campaigns")
        .select("id,title,description,donation_url,status,created_at,published_at,user_id,song_id,campaign_slug")
        .eq("id", id)
        .maybeSingle();

      if (cErr){ showError("Error loading campaign: " + cErr.message); return; }
      if (!c){ showError("Campaign not found (or blocked by RLS)."); return; }

      campaignTitle.textContent = c.title || "(Untitled)";

      // Status pill
      if (c.status){
        campaignStatusPill.style.display = "inline-flex";
        campaignStatusPill.className = "pill primary";
        campaignStatusPill.textContent = String(c.status).toUpperCase();
      }

      const created = c.created_at ? formatDate(c.created_at) : "";
      campaignMeta.textContent = created ? `Created: ${created}` : "";

      if (c.description){
        descBox.style.display = "block";
        campaignDescription.textContent = c.description;
      }

      if (c.donation_url){
        donBox.style.display = "block";
        donationLink.href = c.donation_url;

        stickyDonate.style.display = "block";
        donateBtnTop.href = c.donation_url;
      }

      if (c.song_id){
        const { data: s, error: sErr } = await client
          .from("songs")
          .select("id,audio_url,song_url,cover_url,lyrics,duration_seconds,status,cause_category,cause_condition,condition,created_at")
          .eq("id", c.song_id)
          .maybeSingle();

        if (!sErr && s){
          songBox.style.display = "block";

          const parts = [];
          if (s.status) parts.push(`status: ${s.status}`);
          if (typeof s.duration_seconds === "number" && s.duration_seconds > 0) parts.push(`duration: ${s.duration_seconds}s`);
          songMeta.textContent = parts.length ? parts.join(" ‚Ä¢ ") : "";

          const causeParts = [];
          if (s.cause_category) causeParts.push(s.cause_category);
          if (s.cause_condition) causeParts.push(s.cause_condition);
          if (!s.cause_condition && s.condition) causeParts.push(s.condition);
          if (causeParts.length){
            causeBox.style.display = "block";
            causeText.textContent = causeParts.join(" ‚Äî ");
          }

          const audioSrc = s.audio_url || s.song_url || "";
          if (audioSrc){
            audioEl.style.display = "block";
            audioEl.src = audioSrc;
            noAudio.style.display = "none";
          } else {
            audioEl.style.display = "none";
            noAudio.style.display = "block";
          }

          if (s.cover_url){
            coverBox.style.display = "block";
            coverImg.src = s.cover_url;
          }

          if (s.lyrics){
            lyricsBox.style.display = "block";
            lyricsEl.textContent = s.lyrics;
          }
        }
      }

      // Done
      loadingRow.style.display = "none";
      content.style.display = "block";
    }

    window.addEventListener("pageshow", () => { load(); });
    load();
  </script>
</body>
</html>
