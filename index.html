<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SongRaise Lite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f9fafb;color:#111827;line-height:1.6}
    .wrap{max-width:1120px;margin:0 auto;padding:18px 14px 70px}
    .top{position:sticky;top:0;z-index:50;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;box-shadow:0 10px 24px rgba(15,23,42,.06)}
    .logo{font-weight:900;font-size:1.15rem;letter-spacing:-.02em}
    .logo span{color:#2563eb}
    .auth{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{font-size:.9rem;font-weight:900;color:#374151;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb}
    .auth input{width:240px;padding:8px 10px;border-radius:999px;border:1px solid #d1d5db}
    .btn{padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:900}
    .btn:hover{background:#f3f4f6}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .hero{padding:18px 0}
    h1{font-size:2.0rem;letter-spacing:-.02em;margin-bottom:6px}
    .lead{color:#4b5563;max-width:900px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:16px;box-shadow:0 8px 18px rgba(15,23,42,.04)}
    .card h2{font-size:1.15rem;margin-bottom:10px}
    label{display:block;margin:10px 0 4px;font-size:.85rem;font-weight:900;color:#374151}
    input,textarea,select{width:100%;padding:9px 10px;border-radius:12px;border:1px solid #d1d5db;font-size:.95rem;background:#fff}
    textarea{min-height:92px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:680px){.row2{grid-template-columns:1fr}}
    .status{margin-top:10px;font-size:.92rem;color:#6b7280}
    .error{color:#b91c1c;font-weight:900}
    .ok{color:#047857;font-weight:900}
    table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:.92rem}
    th{background:#f3f4f6;font-size:.85rem;color:#374151}
    tr:last-child td{border-bottom:none}
    .muted{color:#6b7280}
    .link{color:#2563eb;text-decoration:none;font-weight:900}
    .link:hover{text-decoration:underline}
    .mini{font-size:.86rem}
    .hr{border:none;border-top:1px solid #e5e7eb;margin:14px 0}
    .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .file{padding:8px 10px;border:1px solid #d1d5db;border-radius:12px;background:#fff;flex:1}
    .note{font-size:.86rem;color:#6b7280}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">SongRaise<span>Lite</span></div>
      <div class="auth">
        <span class="pill" id="authStatus">Checking login‚Ä¶</span>
        <input id="emailInput" type="email" placeholder="you@email.com" />
        <button class="btn" id="loginBtn" type="button">Email me a login link</button>
        <button class="btn" id="logoutBtn" type="button" style="display:none;">Log out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Create a fundraising song + campaign</h1>
      <p class="lead">
        Uploading an MP3 auto-fills <code>audio_url</code>. Category/Condition dropdowns populate <code>cause_category</code> + <code>cause_condition</code>.
      </p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Create campaign</h2>
        <form id="createForm">
          <label for="title">Campaign title</label>
          <input id="title" required placeholder="e.g., You Are Not Alone" />

          <div class="row2">
            <div>
              <label for="donation_url">Donation URL</label>
              <input id="donation_url" type="url" required placeholder="https://..." />
            </div>
            <div>
              <label for="campaign_slug">Campaign slug (optional)</label>
              <input id="campaign_slug" placeholder="e.g., you-are-not-alone" />
            </div>
          </div>

          <label for="description">Campaign description</label>
          <textarea id="description" placeholder="Short description‚Ä¶"></textarea>

          <div class="hr"></div>

          <h2 style="margin:0 0 6px;font-size:1.05rem;">Song details</h2>
          <p class="note">Upload MP3 to Supabase Storage bucket <b>songs-audio</b> (public). It will fill <code>audio_url</code> automatically.</p>

          <label>Upload MP3 (recommended)</label>
          <div class="stack">
            <input class="file" id="mp3File" type="file" accept="audio/mpeg,audio/mp3" />
            <button class="btn" id="uploadBtn" type="button">Upload MP3</button>
          </div>
          <div id="uploadStatus" class="status"></div>

          <label for="audio_url">Song audio_url (MP3 URL)</label>
          <input id="audio_url" required placeholder="(auto-filled after upload) or paste a public MP3 URL" />

          <div class="row2">
            <div>
              <label for="cover_url">cover_url (optional)</label>
              <input id="cover_url" placeholder="https://.../cover.jpg" />
            </div>
            <div>
              <label for="duration_seconds">duration_seconds (optional)</label>
              <input id="duration_seconds" type="number" min="0" placeholder="e.g., 145" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="cause_category_select">Category</label>
              <select id="cause_category_select"></select>
            </div>
            <div>
              <label for="cause_condition_select">Condition / Symptom</label>
              <select id="cause_condition_select" disabled></select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="cause_category">cause_category (stored)</label>
              <input id="cause_category" placeholder="auto-set from dropdown" />
            </div>
            <div>
              <label for="cause_condition">cause_condition (stored)</label>
              <input id="cause_condition" placeholder="auto-set from dropdown" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="condition">condition (optional)</label>
              <input id="condition" placeholder="optional duplicate/legacy field" />
            </div>
            <div>
              <label for="song_status">song status</label>
              <select id="song_status">
                <option value="ready" selected>ready</option>
                <option value="draft">draft</option>
                <option value="published">published</option>
              </select>
            </div>
          </div>

          <label for="lyrics">Lyrics (optional)</label>
          <textarea id="lyrics" placeholder="Paste lyrics here‚Ä¶"></textarea>

          <div class="stack" style="margin-top:12px;">
            <button class="btn" type="submit" id="createBtn">Create</button>
            <button class="btn" type="button" id="clearBtn">Clear</button>
          </div>

          <div id="createStatus" class="status"></div>
        </form>
      </div>

      <div class="card">
        <h2>My campaigns</h2>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr><th>Title</th><th>Donation</th><th>Created</th><th>View</th></tr>
            </thead>
            <tbody id="campaignsBody"></tbody>
          </table>
        </div>
        <div id="campaignsStatus" class="status">Loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co";
    const SUPABASE_REF = "jvvcxpjmdfeqjdmcemet";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmN4cGptZGZlcWpkbWNlbWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NzYsImV4cCI6MjA3NzE1Mzc3Nn0.LPRIt10bLZYfoOCx7nD4U0PsCURB7YToq4VbByliFi4";

    const BUCKET_AUDIO = "songs-audio";

    const CATEGORY_TO_CONDITIONS = {
      "üß† Neurological Disorders": [
        "Alzheimer‚Äôs Disease",
        "Dementia",
        "Epilepsy",
        "Seizures",
        "Headache",
        "Stroke",
        "Hydrocephalus",
        "Cerebral Palsy",
        "Parkinson‚Äôs Disease",
        "Multiple Sclerosis (MS)"
      ],
      "‚ù§Ô∏è Cardiovascular Diseases": [
        "Arrhythmias",
        "Heart Attack",
        "High Blood Pressure (Hypertension)",
        "High Cholesterol",
        "Vascular Anomalies"
      ],
      "ü©∫ Endocrine & Metabolic Disorders": [
        "Diabetes",
        "Hyperthyroidism",
        "Obesity",
        "Osteoporosis"
      ],
      "ü§∞ Reproductive & Women‚Äôs Health": [
        "Fertility & Reproductive Health (topic)",
        "Rare Pregnancy Complications",
        "Pelvic Floor Disorders",
        "Ovarian Cancer (Cancer)"
      ],
      "üß¨ Genetic & Autoimmune Disorders": [
        "Genetic Disorders",
        "Systemic Lupus Erythematosus (Lupus)",
        "Sj√∂gren‚Äôs Syndrome",
        "Scleroderma"
      ],
      "ü©π Musculoskeletal (Bones, Joints, Soft Tissue)": [
        "Arthritis",
        "Bones and Joints (general)",
        "Scoliosis",
        "Sports-Related Conditions",
        "Knee Injuries",
        "Back and Neck Pain",
        "Hand Conditions"
      ],
      "ü´Å Respiratory Conditions": [
        "Asthma",
        "Influenza",
        "Seasonal Allergies"
      ],
      "üß† Mental Health & Behavioral Conditions": [
        "Anxiety Disorders",
        "Eating Disorders",
        "Mood Disorders",
        "Stress (topic)"
      ],
      "ü¶† Infectious Diseases": [
        "HIV & AIDS",
        "Hepatitis",
        "Herpes (HSV-1 & HSV-2)",
        "Human Papillomavirus (HPV)",
        "Influenza",
        "Lyme Disease",
        "Sexually Transmitted Diseases",
        "Zika Virus",
        "Urinary Tract Infections",
        "Bladder Infections (UTI category)"
      ],
      "ü©ª Gastrointestinal Conditions": [
        "Celiac Disease",
        "Irritable Bowel Syndrome (IBS)",
        "Hernias",
        "Colon Cancer (Cancer)",
        "Stomach (Gastric) Cancer (Cancer)"
      ],
      "üßº Dermatologic Conditions": [
        "Melanoma (Cancer)"
      ],
      "ü©∏ Kidney & Urinary Conditions": [
        "Kidney Stones",
        "End Stage Renal Disease (ESRD)",
        "Urinary Incontinence",
        "Urinary Tract Infections",
        "Kidney Cancer (Cancer)",
        "Bladder Cancer (Cancer)"
      ],
      "üëÅÔ∏è Hearing & Sensory Disorders": [
        "Hearing Loss"
      ],
      "ü¶Ä Cancer (All Types Grouped Together)": [
        "Breast Cancer",
        "Prostate Cancer",
        "Lung Cancer",
        "Colon Cancer",
        "Stomach (Gastric) Cancer",
        "Pancreatic Cancer",
        "Esophageal Cancer",
        "Kidney Cancer",
        "Brain Tumors / Brain Cancer",
        "Head and Neck Cancer",
        "Ovarian Cancer",
        "Bladder Cancer",
        "Melanoma",
        "Sarcoma",
        "Leukemia",
        "Lymphoma"
      ],
      "ü´Å Thoracic / Aortic Conditions": [
        "Abdominal Aortic Aneurysm (AAA)"
      ],
      "ü©π Injury & Pain Conditions": [
        "Knee Injuries",
        "Back & Neck Pain"
      ],
      "Other": ["Other"]
    };

    const authStatusEl = document.getElementById("authStatus");
    const emailEl = document.getElementById("emailInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const campaignsBody = document.getElementById("campaignsBody");
    const campaignsStatus = document.getElementById("campaignsStatus");
    const createStatus = document.getElementById("createStatus");

    const mp3FileEl = document.getElementById("mp3File");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const audioUrlEl = document.getElementById("audio_url");
    const createBtn = document.getElementById("createBtn");

    const catSelect = document.getElementById("cause_category_select");
    const condSelect = document.getElementById("cause_condition_select");
    const catStored = document.getElementById("cause_category");
    const condStored = document.getElementById("cause_condition");
    const legacyCondition = document.getElementById("condition");

    const clientForAuth = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function baseUrl(){
      const u = new URL(window.location.href);
      const basePath = u.pathname.endsWith("/") ? u.pathname : u.pathname.replace(/[^\/]+$/, "");
      return u.origin + basePath;
    }

    function cleanUrl(){
      const url = new URL(window.location.href);
      url.hash = "";
      url.searchParams.delete("code");
      url.searchParams.delete("error");
      url.searchParams.delete("error_code");
      url.searchParams.delete("error_description");
      history.replaceState({}, document.title, url.toString());
    }

    function readHashTokens(){
      const hash = (window.location.hash || "").replace(/^#/, "");
      const p = new URLSearchParams(hash);
      return {
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token"),
        expires_at: p.get("expires_at"),
        expires_in: p.get("expires_in")
      };
    }

    function decodeJwtPayload(jwt){
      try{
        const parts = jwt.split(".");
        if (parts.length < 2) return null;
        const b64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(atob(b64).split("").map(c => "%" + c.charCodeAt(0).toString(16).padStart(2,"0")).join(""));
        return JSON.parse(json);
      } catch(e){ return null; }
    }

    function storageKey(){ return `sb-${SUPABASE_REF}-auth-token`; }

    function saveSessionToStorage(access_token, refresh_token, expires_at, expires_in){
      const now = Math.floor(Date.now()/1000);
      const exp =
        expires_at ? Number(expires_at) :
        expires_in ? (now + Number(expires_in)) :
        (now + 3600);

      localStorage.setItem(storageKey(), JSON.stringify({
        access_token,
        refresh_token,
        token_type: "bearer",
        expires_in: Math.max(0, exp - now),
        expires_at: exp,
        user: null
      }));
    }

    function getStoredSession(){
      const raw = localStorage.getItem(storageKey());
      if (!raw) return null;
      try { return JSON.parse(raw); } catch(e){ return null; }
    }

    function importFromHashIfPresent(){
      const t = readHashTokens();
      if (t.access_token && t.refresh_token){
        saveSessionToStorage(t.access_token, t.refresh_token, t.expires_at, t.expires_in);
        cleanUrl();
      }
    }

    async function refreshIfExpired(){
      const sess = getStoredSession();
      if (!sess?.access_token || !sess?.refresh_token) return;

      const payload = decodeJwtPayload(sess.access_token);
      const now = Math.floor(Date.now()/1000);
      if (!payload?.exp || payload.exp > (now + 60)) return;

      authStatusEl.textContent = "Refreshing‚Ä¶";
      const resp = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
        body: JSON.stringify({ refresh_token: sess.refresh_token })
      });

      if (!resp.ok){
        localStorage.removeItem(storageKey());
        return;
      }

      const data = await resp.json();
      if (data?.access_token && data?.refresh_token){
        saveSessionToStorage(data.access_token, data.refresh_token, null, data.expires_in);
      }
    }

    function currentUserFromStorage(){
      const sess = getStoredSession();
      if (!sess?.access_token) return null;
      const p = decodeJwtPayload(sess.access_token);
      if (!p?.sub) return null;
      return { id: p.sub, email: p.email || "" };
    }

    function buildClient(){
      const sess = getStoredSession();
      const token = sess?.access_token || null;

      if (token){
        return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: window.localStorage },
          global: { headers: { Authorization: `Bearer ${token}` } }
        });
      }

      return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: window.localStorage }
      });
    }

    function setAuthPill(text, isOk){
      authStatusEl.textContent = text;
      logoutBtn.style.display = isOk ? "inline-block" : "none";
    }

    function fillSelect(selectEl, options, placeholder){
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = placeholder;
      selectEl.appendChild(ph);
      options.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        selectEl.appendChild(o);
      });
    }

    function updateConditionDropdown(){
      const cat = catSelect.value || "";
      catStored.value = cat;

      const list = CATEGORY_TO_CONDITIONS[cat] || [];
      if (!cat){
        condSelect.disabled = true;
        fillSelect(condSelect, [], "Select a condition‚Ä¶");
        condStored.value = "";
        legacyCondition.value = "";
        return;
      }

      condSelect.disabled = false;
      fillSelect(condSelect, list, "Select a condition‚Ä¶");
      condSelect.value = "";
      condStored.value = "";
      legacyCondition.value = "";
    }

    async function loadCampaigns(client, user){
      campaignsStatus.textContent = "Loading‚Ä¶";
      campaignsBody.innerHTML = "";

      let q = client
        .from("campaigns")
        .select("id,title,donation_url,created_at,status,user_id")
        .order("created_at", { ascending: false })
        .limit(30);

      if (user) q = q.eq("user_id", user.id);
      else q = q.eq("status", "published");

      const { data, error } = await q;

      if (error){
        campaignsStatus.textContent = "Error: " + error.message;
        campaignsStatus.classList.add("error");
        return;
      }

      if (!data || data.length === 0){
        campaignsStatus.textContent = user ? "No campaigns yet." : "No published campaigns.";
        return;
      }

      const base = baseUrl();
      campaignsBody.innerHTML = data.map(c => {
        const t = c.title || "(Untitled)";
        const d = c.donation_url ? `<a class="link" href="${c.donation_url}" target="_blank" rel="noopener noreferrer">Open</a>` : "‚Äî";
        const created = c.created_at ? new Date(c.created_at).toLocaleString() : "";
        const view = `${base}campaign.html?id=${encodeURIComponent(c.id)}`;
        return `<tr><td>${t}</td><td>${d}</td><td>${created}</td><td><a class="link" href="${view}">View</a></td></tr>`;
      }).join("");

      campaignsStatus.textContent = `Showing ${data.length} campaign(s).`;
    }

    async function refreshAll(){
      importFromHashIfPresent();
      await refreshIfExpired();
      const user = currentUserFromStorage();
      const client = buildClient();
      setAuthPill(user ? "Logged in ‚úÖ" : "Logged out", !!user);
      await loadCampaigns(client, user);
      return { user, client };
    }

    function safeFileName(name){
      return (name || "audio.mp3")
        .toLowerCase()
        .replace(/[^a-z0-9\.\-_]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");
    }

    uploadBtn.addEventListener("click", async () => {
      uploadStatus.textContent = "";
      uploadStatus.classList.remove("error","ok");

      const file = mp3FileEl.files && mp3FileEl.files[0];
      if (!file){
        uploadStatus.textContent = "Choose an MP3 file first.";
        uploadStatus.classList.add("error");
        return;
      }

      const { user, client } = await refreshAll();
      if (!user){
        uploadStatus.textContent = "Please log in first, then upload.";
        uploadStatus.classList.add("error");
        return;
      }

      uploadBtn.disabled = true;
      createBtn.disabled = true;
      uploadStatus.textContent = "Uploading‚Ä¶";

      const path = `${user.id}/${Date.now()}-${safeFileName(file.name)}`;

      const { error: upErr } = await client
        .storage
        .from(BUCKET_AUDIO)
        .upload(path, file, { upsert: true, contentType: file.type || "audio/mpeg" });

      if (upErr){
        uploadStatus.textContent = "Upload failed: " + upErr.message;
        uploadStatus.classList.add("error");
        uploadBtn.disabled = false;
        createBtn.disabled = false;
        return;
      }

      const { data: pub } = client.storage.from(BUCKET_AUDIO).getPublicUrl(path);
      const publicUrl = pub?.publicUrl || "";

      if (!publicUrl){
        uploadStatus.textContent = "Upload succeeded, but could not build public URL.";
        uploadStatus.classList.add("error");
      } else {
        audioUrlEl.value = publicUrl;
        uploadStatus.textContent = "Uploaded ‚úÖ audio_url filled.";
        uploadStatus.classList.add("ok");
      }

      uploadBtn.disabled = false;
      createBtn.disabled = false;
    });

    loginBtn.addEventListener("click", async () => {
      const email = (emailEl.value || "").trim();
      if (!email){ alert("Type your email first."); return; }
      const redirectTo = `${baseUrl()}index.html?v=${Date.now()}`;
      setAuthPill("Sending link‚Ä¶", false);
      const { error } = await clientForAuth.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo } });
      if (error){ setAuthPill("Logged out", false); alert("Login error: " + error.message); return; }
      alert("Login email sent. Open the newest email and click the login link once.");
      setAuthPill("Check your email (link sent)", false);
    });

    logoutBtn.addEventListener("click", async () => {
      localStorage.removeItem(storageKey());
      await refreshAll();
    });

    catSelect.addEventListener("change", updateConditionDropdown);

    condSelect.addEventListener("change", () => {
      const v = condSelect.value || "";
      condStored.value = v;
      legacyCondition.value = v;
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("createForm").reset();
      uploadStatus.textContent = "";
      uploadStatus.classList.remove("error","ok");
      createStatus.textContent = "";
      createStatus.classList.remove("error");
      condSelect.disabled = true;
      fillSelect(condSelect, [], "Select a condition‚Ä¶");
      catStored.value = "";
      condStored.value = "";
      legacyCondition.value = "";
    });

    document.getElementById("createForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      createStatus.textContent = "";
      createStatus.classList.remove("error");

      const { user, client } = await refreshAll();
      if (!user){
        createStatus.textContent = "Please log in first.";
        createStatus.classList.add("error");
        return;
      }

      const campaignTitle = document.getElementById("title").value.trim();
      const donation_url = document.getElementById("donation_url").value.trim();
      const campaign_slug = document.getElementById("campaign_slug").value.trim() || null;
      const description = document.getElementById("description").value.trim() || null;

      const audio_url = document.getElementById("audio_url").value.trim();
      const cover_url = document.getElementById("cover_url").value.trim() || null;
      const duration_seconds_raw = document.getElementById("duration_seconds").value.trim();
      const duration_seconds = duration_seconds_raw ? Number(duration_seconds_raw) : null;

      const cause_category = catStored.value.trim() || null;
      const cause_condition = condStored.value.trim() || null;
      const condition = legacyCondition.value.trim() || null;

      const song_status = document.getElementById("song_status").value.trim() || "ready";
      const lyrics = document.getElementById("lyrics").value.trim() || null;

      if (!campaignTitle || !donation_url || !audio_url){
        createStatus.textContent = "Please fill Campaign title, Donation URL, and Song audio_url (upload MP3 to auto-fill).";
        createStatus.classList.add("error");
        return;
      }

      createBtn.disabled = true;
      createStatus.textContent = "Creating song‚Ä¶";

      const { data: songRow, error: songErr } = await client
        .from("songs")
        .insert({
          audio_url,
          cover_url,
          duration_seconds,
          lyrics,
          cause_category,
          cause_condition,
          condition,
          status: song_status
        })
        .select("id")
        .single();

      if (songErr){
        createStatus.textContent = "Error creating song: " + songErr.message;
        createStatus.classList.add("error");
        createBtn.disabled = false;
        return;
      }

      createStatus.textContent = "Creating campaign‚Ä¶";

      const { error: campErr } = await client
        .from("campaigns")
        .insert({
          user_id: user.id,
          song_id: songRow.id,
          title: campaignTitle,
          description,
          donation_url,
          campaign_slug,
          status: "published"
        });

      if (campErr){
        createStatus.textContent = "Error creating campaign: " + campErr.message;
        createStatus.classList.add("error");
        createBtn.disabled = false;
        return;
      }

      createStatus.textContent = "Created ‚úÖ";
      createBtn.disabled = false;
      await refreshAll();

      document.getElementById("createForm").reset();
      uploadStatus.textContent = "";
      uploadStatus.classList.remove("error","ok");
      condSelect.disabled = true;
      fillSelect(condSelect, [], "Select a condition‚Ä¶");
      catStored.value = "";
      condStored.value = "";
      legacyCondition.value = "";
    });

    (function init(){
      const categories = Object.keys(CATEGORY_TO_CONDITIONS);
      fillSelect(catSelect, categories, "Select a category‚Ä¶");
      fillSelect(condSelect, [], "Select a condition‚Ä¶");
      condSelect.disabled = true;
      refreshAll();
    })();

    window.addEventListener("pageshow", () => { refreshAll(); });
  </script>
</body>
</html>
