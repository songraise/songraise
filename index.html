<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SongRaise Lite – Turn Your Cause Into a Song</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.6;
      color: #111827;
      background: #f9fafb;
    }
    a { text-decoration: none; color: inherit; }
    .wrapper { max-width: 1100px; margin: 0 auto; padding: 24px 16px 64px; }
    header { padding: 16px 0 24px; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-weight: 800; font-size: 1.25rem; }
    .logo span { color: #2563eb; }
    nav a { margin-left: 20px; font-size: 0.95rem; color: #4b5563; }
    nav a:hover { color: #111827; }

    .btn { display: inline-block; padding: 10px 18px; border-radius: 999px; font-weight: 600; font-size: 0.95rem; border: none; cursor: pointer; }
    .btn-primary { background: #2563eb; color: #ffffff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-ghost { background: transparent; border: 1px solid #d1d5db; color: #111827; }
    .btn-ghost:hover { background: #e5e7eb; }

    .hero { display: grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr); gap: 40px; padding: 32px 0 40px; align-items: center; }
    .hero h1 { font-size: clamp(2.2rem, 3.2vw, 3rem); font-weight: 800; margin-bottom: 16px; }
    .hero p { font-size: 1.05rem; color: #4b5563; margin-bottom: 20px; }
    .hero-cta { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
    .hero-note { font-size: 0.85rem; color: #6b7280; }
    .hero-visual { background: #111827; border-radius: 16px; padding: 20px; color: #f9fafb; box-shadow: 0 20px 35px rgba(15,23,42,0.3); }
    .hero-visual h3 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.08em; color: #9ca3af; margin-bottom: 8px; }
    .hero-visual-main { font-size: 1.1rem; margin-bottom: 16px; }
    .hero-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .tag { padding: 4px 10px; border-radius: 999px; background: rgba(37,99,235,0.15); font-size: 0.8rem; }
    .hero-metrics { display: flex; gap: 16px; font-size: 0.85rem; color: #9ca3af; }
    .hero-metrics strong { display: block; font-size: 1rem; color: #e5e7eb; }

    .section { padding: 32px 0; }
    .section h2 { font-size: 1.6rem; margin-bottom: 12px; }
    .section p.lead { color: #4b5563; margin-bottom: 24px; max-width: 650px; }

    .card { background:#ffffff; border-radius:16px; border:1px solid #e5e7eb; padding:18px 16px 20px; font-size:0.9rem; }
    .card h3 { font-size:1.05rem; margin-bottom:8px; }

    .field-label { display:block; font-size:0.85rem; margin-bottom:3px; color:#374151; }
    .field-input, .field-select, .field-textarea {
      width:100%; padding:8px; margin-bottom:10px; border-radius:8px; border:1px solid #d1d5db; font-size:0.9rem;
    }
    .field-textarea { resize: vertical; min-height:60px; }
    .status-text { font-size:0.85rem; margin-top:6px; }

    .auth-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }

    .whitebar {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px 12px;
      margin: 0 0 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .whitebar strong { font-size: 0.95rem; }
    .whitebar small { color: #6b7280; }

    @media (max-width: 768px) {
      .hero { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      nav { font-size: 0.9rem; }
    }
  </style>
</head>

<body>
  <div class="wrapper">

    <header>
      <div class="logo">SongRaise<span>Lite</span></div>
      <nav>
        <a href="#account">Account</a>
        <a href="#create-song">Create</a>
        <a href="#my-campaigns">My campaigns</a>
      </nav>
    </header>

    <!-- DEMO MODE BAR -->
    <div class="whitebar">
      <div>
        <strong>Demo mode</strong>
        <small id="demoModeHint">Off</small>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button id="demoToggleBtn" class="btn btn-ghost" type="button">Enable Demo Mode</button>
        <button id="demoCreateBtn" class="btn btn-primary" type="button">Create Demo Campaign</button>
      </div>
    </div>

    <!-- Hero -->
    <section class="hero" id="start">
      <div>
        <h1>Turn Your Cause Into a Song in 60 Seconds</h1>
        <p>
          Pick a cause, emotion, genre, and style — then save your campaign.
          Upload an MP3 to play directly inside SongRaise (no Suno link required).
        </p>
        <div class="hero-cta">
          <a href="#create-song" class="btn btn-primary">Create a campaign</a>
          <a href="#my-campaigns" class="btn btn-ghost">View campaigns</a>
        </div>
        <p class="hero-note">
          MVP workflow: save records first → add AI generation automation later.
        </p>
      </div>
      <div class="hero-visual">
        <h3>Live Preview</h3>
        <div class="hero-visual-main">
          “Mental Health Awareness · Hopeful Pop”<br />
          <span style="font-size:0.9rem; color:#9ca3af;">
            Ready to post · Donation link attached
          </span>
        </div>
        <div class="hero-tags">
          <div class="tag">Campaign record</div>
          <div class="tag">MP3 playback</div>
          <div class="tag">Donation link</div>
        </div>
        <div class="hero-metrics">
          <div><strong>Demo</strong> Mode</div>
          <div><strong>MVP</strong> Build</div>
        </div>
      </div>
    </section>

    <!-- ACCOUNT / AUTH -->
    <section class="section" id="account">
      <h2>Login or Create Your Account</h2>
      <p class="lead">
        Log in to attach campaigns to your account.
      </p>

      <p id="authStatusText" style="font-size:0.9rem; margin-bottom:12px;">Not logged in.</p>

      <div class="auth-grid">
        <!-- Log in -->
        <div class="card">
          <h3>Log in</h3>
          <form id="loginForm">
            <label class="field-label" for="loginEmail">Email</label>
            <input id="loginEmail" type="email" class="field-input" required />

            <label class="field-label" for="loginPassword">Password</label>
            <input id="loginPassword" type="password" class="field-input" required />

            <button type="submit" class="btn btn-primary">Log in</button>
            <div id="loginStatus" class="status-text"></div>
          </form>
        </div>

        <!-- Create account -->
        <div class="card">
          <h3>Create an account</h3>
          <form id="signupForm">
            <label class="field-label" for="signupName">Name</label>
            <input id="signupName" type="text" class="field-input" placeholder="Your name" />

            <label class="field-label" for="signupEmail">Email</label>
            <input id="signupEmail" type="email" class="field-input" required />

            <label class="field-label" for="signupPassword">Password</label>
            <input id="signupPassword" type="password" class="field-input" required />

            <button type="submit" class="btn btn-primary">Create account</button>
            <div id="signupStatus" class="status-text"></div>
          </form>
        </div>

        <!-- Account panel -->
        <div class="card">
          <h3>Account</h3>
          <p style="font-size:0.9rem;">
            Email: <span id="accountEmail">Not logged in</span><br/>
            Org status: <span id="accountOrgStatus">—</span>
          </p>

          <form id="displayNameForm" style="margin-top:10px;">
            <label class="field-label" for="displayNameInput">Display name (optional)</label>
            <input id="displayNameInput" type="text" class="field-input" placeholder="How you want to appear" />
            <button type="submit" class="btn btn-ghost">Save name</button>
            <div id="displayNameStatus" class="status-text"></div>
          </form>

          <button id="logoutButton" class="btn btn-ghost" style="margin-top:12px;">Log out</button>
        </div>
      </div>
    </section>

    <!-- CREATE SONG & CAMPAIGN -->
    <section class="section" id="create-song">
      <h2>Create a Fundraising Song and Campaign</h2>
      <p class="lead">
        Upload an MP3 directly (recommended), or paste a URL.
      </p>

      <form id="createSongForm" style="max-width: 640px;" class="card">
        <label for="cause" class="field-label">Cause</label>
        <select id="cause" required class="field-select">
          <option value="">Select a cause...</option>
          <option value="mental_health">Mental Health</option>
          <option value="animal_rescue">Animal Rescue</option>
          <option value="cancer_support">Cancer Support</option>
        </select>

        <label for="emotion" class="field-label">Emotion</label>
        <select id="emotion" required class="field-select">
          <option value="Hopeful">Hopeful</option>
          <option value="Comforting">Comforting</option>
          <option value="Inspiring">Inspiring</option>
          <option value="Strong">Strong</option>
        </select>

        <label for="genre" class="field-label">Genre</label>
        <select id="genre" required class="field-select">
          <option value="Pop">Pop</option>
          <option value="Acoustic">Acoustic</option>
          <option value="Folk">Folk</option>
          <option value="Ballad">Ballad</option>
        </select>

        <label for="style" class="field-label">Artist style (optional)</label>
        <input id="style" type="text" class="field-input" placeholder="e.g., like Ed Sheeran" />

        <label for="donation_url" class="field-label">Donation page URL</label>
        <input id="donation_url" type="url" required class="field-input" placeholder="https://..." />

        <label for="campaign_title" class="field-label">Campaign title</label>
        <input id="campaign_title" type="text" required class="field-input" placeholder="e.g., You Are Not Alone" />

        <label for="campaign_description" class="field-label">Campaign description</label>
        <textarea id="campaign_description" class="field-textarea" placeholder="Short description..."></textarea>

        <label class="field-label">Song audio</label>
        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="audio_file" type="file" accept="audio/*" style="font-size:0.85rem;">
          <button type="button" id="uploadAudioBtn" class="btn btn-primary" style="padding:8px 14px;">Upload MP3</button>
          <span id="uploadAudioStatus" style="font-size:0.8rem; color:#6b7280;"></span>
        </div>

        <label for="audio_url" class="field-label">Audio URL (auto-filled after upload)</label>
        <input id="audio_url" type="url" class="field-input" placeholder="(filled after upload)" />

        <input type="hidden" id="lyric_prompt" />

        <button type="submit" class="btn btn-primary" style="margin-top:6px;">Create Song and Campaign</button>
        <div id="createSongStatus" class="status-text"></div>
      </form>
    </section>

    <!-- My Campaigns -->
    <section class="section" id="my-campaigns">
      <h2>My Campaigns</h2>
      <p class="lead">Your saved campaigns appear here.</p>

      <div id="impactSummary" style="display:flex; flex-wrap:wrap; gap:16px; margin-bottom:12px; font-size:0.9rem;">
        <div style="padding:8px 12px; border-radius:10px; background:#eef2ff;">
          <strong id="impactTotalCampaigns">0</strong><br/>Campaigns
        </div>
        <div style="padding:8px 12px; border-radius:10px; background:#ecfeff;">
          <strong id="impactLatestCreated">—</strong><br/>Latest
        </div>
      </div>

      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem; background:#ffffff; border-radius:12px; border:1px solid #e5e7eb;">
          <thead>
            <tr style="background:#f3f4f6;">
              <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #e5e7eb;">Title</th>
              <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #e5e7eb;">Donation link</th>
              <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #e5e7eb;">Status</th>
              <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #e5e7eb;">Created</th>
              <th style="text-align:left; padding:8px 10px; border-bottom:1px solid #e5e7eb;">View</th>
            </tr>
          </thead>
          <tbody id="campaignsTableBody"></tbody>
        </table>
      </div>

      <p id="myCampaignsStatus" style="margin-top:8px; font-size:0.85rem; color:#6b7280;">Log in to see campaigns.</p>
    </section>

    <footer style="border-top:1px solid #e5e7eb; margin-top:32px; padding-top:16px; font-size:0.8rem; color:#6b7280;">
      © <span id="year"></span> SongRaise Lite
    </footer>

  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /**************************************
     * SUPABASE INITIALIZATION
     **************************************/
    const SUPABASE_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmN4cGptZGZlcWpkbWNlbWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NzYsImV4cCI6MjA3NzE1Mzc3Nn0.LPRIt10bLZYfoOCx7nD4U0PsCURB7YToq4VbByliFi4";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /**************************************
     * ELEMENTS
     **************************************/
    const authStatusText = document.getElementById("authStatusText");
    const accountEmailSpan = document.getElementById("accountEmail");
    const accountOrgStatusSpan = document.getElementById("accountOrgStatus");

    const loginForm = document.getElementById("loginForm");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const loginStatus = document.getElementById("loginStatus");

    const signupForm = document.getElementById("signupForm");
    const signupNameInput = document.getElementById("signupName");
    const signupEmailInput = document.getElementById("signupEmail");
    const signupPasswordInput = document.getElementById("signupPassword");
    const signupStatus = document.getElementById("signupStatus");

    const logoutButton = document.getElementById("logoutButton");

    const displayNameForm = document.getElementById("displayNameForm");
    const displayNameInput = document.getElementById("displayNameInput");
    const displayNameStatus = document.getElementById("displayNameStatus");

    const createSongForm = document.getElementById("createSongForm");
    const createSongStatus = document.getElementById("createSongStatus");

    const campaignsTableBody = document.getElementById("campaignsTableBody");
    const myCampaignsStatus = document.getElementById("myCampaignsStatus");
    const impactTotalCampaigns = document.getElementById("impactTotalCampaigns");
    const impactLatestCreated = document.getElementById("impactLatestCreated");

    const causeSelect = document.getElementById("cause");
    const emotionSelect = document.getElementById("emotion");
    const genreSelect = document.getElementById("genre");
    const lyricPromptInput = document.getElementById("lyric_prompt");

    const audioUrlInput = document.getElementById("audio_url");
    const audioFileInput = document.getElementById("audio_file");
    const uploadAudioBtn = document.getElementById("uploadAudioBtn");
    const uploadAudioStatus = document.getElementById("uploadAudioStatus");

    const demoToggleBtn = document.getElementById("demoToggleBtn");
    const demoCreateBtn = document.getElementById("demoCreateBtn");
    const demoModeHint = document.getElementById("demoModeHint");

    let currentUser = null;
    let demoMode = false;

    // Your demo MP3 URL (wired in)
    const DEMO_MP3_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co/storage/v1/object/public/song-audio/Untitled%20folder/Well%20I%20knew%20I%20felt%20a%20tingle%20when%20my%20head%20(1).mp3";

    /**************************************
     * HELPERS
     **************************************/
    function formatDateTime(str) {
      if (!str) return "";
      const d = new Date(str);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString();
    }

    function campaignViewUrl(campaignId) {
      // ✅ GitHub Pages-safe: resolves correctly whether site is / or /songraise/
      const url = new URL("campaign.html", window.location.href);
      url.searchParams.set("id", campaignId);
      return url.toString();
    }

    function setDemoMode(on) {
      demoMode = !!on;
      demoModeHint.textContent = demoMode ? "On (auto-fill enabled)" : "Off";
      demoToggleBtn.textContent = demoMode ? "Disable Demo Mode" : "Enable Demo Mode";
    }

    /**************************************
     * AUTH: refresh + UI
     **************************************/
    async function refreshUser() {
      const { data, error } = await supabaseClient.auth.getUser();
      currentUser = (!error && data?.user) ? data.user : null;
      updateAuthUI();
      if (currentUser) {
        await loadDisplayName();
        await loadOrgStatus();
        await loadCampaigns();
      } else {
        clearCampaignsTable();
      }
    }

    function updateAuthUI() {
      if (currentUser) {
        authStatusText.textContent = "Logged in.";
        accountEmailSpan.textContent = currentUser.email || "(no email)";
      } else {
        authStatusText.textContent = "Not logged in.";
        accountEmailSpan.textContent = "Not logged in";
        accountOrgStatusSpan.textContent = "—";
        displayNameInput.value = "";
      }
    }

    /**************************************
     * LOGIN / SIGNUP / LOGOUT
     **************************************/
    loginForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginStatus.textContent = "Logging in...";
      loginStatus.style.color = "#6b7280";

      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value;

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        loginStatus.textContent = "Login error: " + error.message;
        loginStatus.style.color = "red";
        return;
      }

      loginStatus.textContent = "Logged in.";
      loginStatus.style.color = "green";
      await refreshUser();
    });

    signupForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      signupStatus.textContent = "Creating account...";
      signupStatus.style.color = "#6b7280";

      const name = signupNameInput.value.trim();
      const email = signupEmailInput.value.trim();
      const password = signupPasswordInput.value;

      const { error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: { data: { full_name: name || null } }
      });

      if (error) {
        console.error(error);
        signupStatus.textContent = "Signup error: " + error.message;
        signupStatus.style.color = "red";
        return;
      }

      signupStatus.textContent = "Account created. You can log in now.";
      signupStatus.style.color = "green";
    });

    logoutButton?.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      currentUser = null;
      updateAuthUI();
      clearCampaignsTable();
    });

    /**************************************
     * DISPLAY NAME (profiles)
     **************************************/
    async function loadDisplayName() {
      if (!currentUser) return;
      const { data, error } = await supabaseClient
        .from("profiles")
        .select("display_name")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (error) return;
      if (data?.display_name) displayNameInput.value = data.display_name;
    }

    displayNameForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        displayNameStatus.textContent = "Please log in first.";
        displayNameStatus.style.color = "red";
        return;
      }

      displayNameStatus.textContent = "Saving...";
      displayNameStatus.style.color = "#6b7280";

      const name = displayNameInput.value.trim();
      const { error } = await supabaseClient
        .from("profiles")
        .upsert({ id: currentUser.id, display_name: name }, { onConflict: "id" });

      if (error) {
        console.error(error);
        displayNameStatus.textContent = "Error saving name: " + error.message;
        displayNameStatus.style.color = "red";
        return;
      }

      displayNameStatus.textContent = "Saved.";
      displayNameStatus.style.color = "green";
    });

    /**************************************
     * ORG STATUS
     **************************************/
    async function loadOrgStatus() {
      if (!currentUser) return;
      const { data, error } = await supabaseClient
        .from("org_signups")
        .select("status, created_at")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) {
        accountOrgStatusSpan.textContent = "Error loading.";
        return;
      }
      accountOrgStatusSpan.textContent = data?.status ? data.status : "No application yet.";
    }

    /**************************************
     * MP3 UPLOAD
     **************************************/
    uploadAudioBtn?.addEventListener("click", async () => {
      uploadAudioStatus.textContent = "";
      uploadAudioStatus.style.color = "#6b7280";

      const file = audioFileInput.files?.[0];
      if (!file) {
        uploadAudioStatus.textContent = "Choose an audio file first.";
        uploadAudioStatus.style.color = "red";
        return;
      }
      if (!file.type.startsWith("audio/")) {
        uploadAudioStatus.textContent = "Please upload an audio file (MP3, WAV, etc.).";
        uploadAudioStatus.style.color = "red";
        return;
      }
      if (!currentUser) {
        uploadAudioStatus.textContent = "Please log in before uploading.";
        uploadAudioStatus.style.color = "red";
        return;
      }

      uploadAudioStatus.textContent = "Uploading...";
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
      const filePath = `${currentUser.id}/${timestamp}-${safeName}`;

      const { error: uploadError } = await supabaseClient.storage
        .from("song-audio")
        .upload(filePath, file, { cacheControl: "3600", upsert: false });

      if (uploadError) {
        console.error(uploadError);
        uploadAudioStatus.textContent = "Upload failed: " + uploadError.message;
        uploadAudioStatus.style.color = "red";
        return;
      }

      const { data: publicData } = supabaseClient.storage.from("song-audio").getPublicUrl(filePath);
      if (!publicData?.publicUrl) {
        uploadAudioStatus.textContent = "Uploaded, but couldn't get public URL.";
        uploadAudioStatus.style.color = "red";
        return;
      }

      audioUrlInput.value = publicData.publicUrl;
      uploadAudioStatus.textContent = "Upload complete. Audio URL attached.";
      uploadAudioStatus.style.color = "green";
    });

    /**************************************
     * CAMPAIGNS TABLE
     **************************************/
    function clearCampaignsTable() {
      campaignsTableBody.innerHTML = "";
      myCampaignsStatus.textContent = "Log in to see your campaigns.";
      myCampaignsStatus.style.color = "#6b7280";
      impactTotalCampaigns.textContent = "0";
      impactLatestCreated.textContent = "—";
    }

    async function loadCampaigns() {
      if (!currentUser) return clearCampaignsTable();

      myCampaignsStatus.textContent = "Loading campaigns...";
      myCampaignsStatus.style.color = "#6b7280";

      const { data, error } = await supabaseClient
        .from("campaigns")
        .select("id, title, donation_url, status, created_at")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        myCampaignsStatus.textContent = "Error loading campaigns: " + error.message;
        myCampaignsStatus.style.color = "red";
        return;
      }

      if (!data?.length) {
        campaignsTableBody.innerHTML = "";
        myCampaignsStatus.textContent = "No campaigns yet.";
        impactTotalCampaigns.textContent = "0";
        impactLatestCreated.textContent = "—";
        return;
      }

      campaignsTableBody.innerHTML = data.map((c) => {
        const safeTitle = c.title || "(No title)";
        const safeStatus = c.status || "draft";
        const created = formatDateTime(c.created_at);
        const donationCell = c.donation_url
          ? `<a href="${c.donation_url}" target="_blank" rel="noopener noreferrer">Open link</a>`
          : "—";

        // ✅ FIXED VIEW LINK (GitHub Pages-safe)
        const viewHref = campaignViewUrl(c.id);
        const viewLink = `<a href="${viewHref}" target="_blank" rel="noopener noreferrer">View</a>`;

        return `
          <tr>
            <td style="padding:8px 10px; border-bottom:1px solid #e5e7eb;">${safeTitle}</td>
            <td style="padding:8px 10px; border-bottom:1px solid #e5e7eb;">${donationCell}</td>
            <td style="padding:8px 10px; border-bottom:1px solid #e5e7eb; text-transform:capitalize;">${safeStatus}</td>
            <td style="padding:8px 10px; border-bottom:1px solid #e5e7eb;">${created}</td>
            <td style="padding:8px 10px; border-bottom:1px solid #e5e7eb;">${viewLink}</td>
          </tr>
        `;
      }).join("");

      myCampaignsStatus.textContent = `Showing ${data.length} campaign(s).`;
      impactTotalCampaigns.textContent = String(data.length);
      impactLatestCreated.textContent = formatDateTime(data[0].created_at);
    }

    /**************************************
     * CREATE SONG + CAMPAIGN
     **************************************/
    createSongForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentUser) {
        createSongStatus.textContent = "Please log in first.";
        createSongStatus.style.color = "red";
        return;
      }

      createSongStatus.textContent = "Saving...";
      createSongStatus.style.color = "#6b7280";

      const cause = causeSelect.value;
      const emotion = emotionSelect.value;
      const genre = genreSelect.value;
      const style = document.getElementById("style").value.trim() || null;
      const donationUrl = document.getElementById("donation_url").value.trim();
      const campaignTitle = document.getElementById("campaign_title").value.trim();
      const campaignDescription = document.getElementById("campaign_description").value.trim() || null;
      const audioUrl = audioUrlInput.value.trim() || null;
      const lyricPrompt = lyricPromptInput.value || "Write lyrics for a fundraising song.";

      if (!cause || !emotion || !genre || !donationUrl || !campaignTitle) {
        createSongStatus.textContent = "Please fill in all required fields.";
        createSongStatus.style.color = "red";
        return;
      }

      // Insert song
      const { data: songData, error: songError } = await supabaseClient
        .from("songs")
        .insert({
          cause,
          emotion,
          genre,
          style,
          lyric_prompt: lyricPrompt,
          audio_url: audioUrl,
          status: "draft"
        })
        .select()
        .single();

      if (songError) {
        console.error(songError);
        createSongStatus.textContent = "Error saving song: " + songError.message;
        createSongStatus.style.color = "red";
        return;
      }

      // Create slug (basic)
      const baseSlug = campaignTitle
        .toLowerъяse()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");

      // Add timestamp to avoid unique slug collisions
      const slug = `${baseSlug}-${Date.now()}`;

      const { error: campaignError } = await supabaseClient
        .from("campaigns")
        .insert({
          user_id: currentUser.id,
          song_id: songData.id,
          title: campaignTitle,
          description: campaignDescription,
          donation_url: donationUrl,
          campaign_slug: slug,
          status: "draft"
        });

      if (campaignError) {
        console.error(campaignError);
        createSongStatus.textContent = "Error saving campaign: " + campaignError.message;
        createSongStatus.style.color = "red";
        return;
      }

      createSongStatus.textContent = "Saved! Campaign created.";
      createSongStatus.style.color = "green";

      createSongForm.reset();
      audioUrlInput.value = "";
      lyricPromptInput.value = "";

      await loadCampaigns();
    });

    /**************************************
     * DEMO MODE
     **************************************/
    demoToggleBtn?.addEventListener("click", () => setDemoMode(!demoMode));

    demoCreateBtn?.addEventListener("click", async () => {
      if (!demoMode) {
        alert("Enable Demo Mode first.");
        return;
      }
      if (!currentUser) {
        alert("Please log in first.");
        return;
      }

      // Fill form
      causeSelect.value = "mental_health";
      emotionSelect.value = "Hopeful";
      genreSelect.value = "Pop";
      document.getElementById("style").value = "Like Ed Sheeran";
      document.getElementById("donation_url").value = "https://example.org/donate";
      document.getElementById("campaign_title").value = "Demo Campaign – You Are Not Alone";
      document.getElementById("campaign_description").value = "This is a demo campaign created for testing.";
      audioUrlInput.value = DEMO_MP3_URL;
      lyricPromptInput.value = "Write comforting, hopeful lyrics about mental health support. Include resilience and a call-to-action to donate.";

      // Auto-submit
      createSongForm.dispatchEvent(new Event("submit", { cancelable: true }));
    });

    // Start
    setDemoMode(false);
    refreshUser();
  </script>
</body>
</html>
