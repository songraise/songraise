<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SongRaise Lite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f9fafb;color:#111827;line-height:1.6}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 70px}
    .top{position:sticky;top:0;z-index:50;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;box-shadow:0 10px 24px rgba(15,23,42,.06)}
    .logo{font-weight:900;font-size:1.15rem;letter-spacing:-.02em}
    .logo span{color:#2563eb}
    .auth{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .auth span{font-size:.9rem;font-weight:800;color:#374151}
    .auth input{width:240px;padding:8px 10px;border-radius:999px;border:1px solid #d1d5db}
    .btn{padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:800}
    .btn:hover{background:#f3f4f6}
    .hero{padding:18px 0}
    h1{font-size:1.9rem;letter-spacing:-.02em;margin-bottom:6px}
    .lead{color:#4b5563;margin-bottom:14px;max-width:820px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 8px 18px rgba(15,23,42,.04)}
    label{display:block;margin:10px 0 4px;font-size:.85rem;font-weight:900;color:#374151}
    input,textarea{width:100%;padding:9px 10px;border-radius:12px;border:1px solid #d1d5db;font-size:.95rem;background:#fff}
    textarea{min-height:90px;resize:vertical}
    table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:.92rem}
    th{background:#f3f4f6;font-size:.85rem;color:#374151}
    tr:last-child td{border-bottom:none}
    .status{margin-top:10px;font-size:.9rem;color:#6b7280}
    .error{color:#b91c1c;font-weight:900}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">SongRaise<span>Lite</span></div>
      <div class="auth">
        <span id="authStatus">Checking login…</span>
        <input id="emailInput" type="email" placeholder="you@email.com" />
        <button class="btn" id="loginBtn" type="button">Email me a login link</button>
        <button class="btn" id="logoutBtn" type="button" style="display:none;">Log out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Create a fundraising song + campaign</h1>
      <p class="lead">“View” opens <code>campaign.html?id=...</code>. Login should persist.</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2 style="margin-bottom:8px;">Create campaign</h2>
        <form id="createForm">
          <label for="title">Title</label>
          <input id="title" required placeholder="e.g., You Are Not Alone" />
          <label for="donation_url">Donation URL</label>
          <input id="donation_url" type="url" required placeholder="https://..." />
          <label for="description">Description</label>
          <textarea id="description" placeholder="Short description…"></textarea>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
            <button class="btn" type="submit">Create</button>
          </div>
          <div id="createStatus" class="status"></div>
        </form>
      </div>

      <div class="card">
        <h2 style="margin-bottom:8px;">Campaigns</h2>
        <div style="overflow-x:auto;">
          <table>
            <thead><tr><th>Title</th><th>Donation</th><th>Created</th><th>View</th></tr></thead>
            <tbody id="campaignsBody"></tbody>
          </table>
        </div>
        <div id="campaignsStatus" class="status">Loading campaigns…</div>
      </div>
    </div>
  </div>

  <script>
    const authStatusEl = document.getElementById("authStatus");
    authStatusEl.textContent = "JS running…";
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
    onload="window.__sbLoaded = true"
    onerror="window.__sbLoaded = false"
  ></script>

  <script>
    const SUPABASE_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co";
    const SUPABASE_REF = "jvvcxpjmdfeqjdmcemet";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmN4cGptZGZlcWpkbWNlbWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NzYsImV4cCI6MjA3NzE1Mzc3Nn0.LPRIt10bLZYfoOCx7nD4U0PsCURB7YToq4VbByliFi4";

    const emailEl = document.getElementById("emailInput");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const campaignsBody = document.getElementById("campaignsBody");
    const campaignsStatus = document.getElementById("campaignsStatus");
    const createStatus = document.getElementById("createStatus");

    function baseUrl(){
      const u = new URL(window.location.href);
      const basePath = u.pathname.endsWith("/") ? u.pathname : u.pathname.replace(/[^\/]+$/, "");
      return u.origin + basePath;
    }

    function cleanUrl(){
      const url = new URL(window.location.href);
      url.hash = "";
      url.searchParams.delete("code");
      url.searchParams.delete("error");
      url.searchParams.delete("error_code");
      url.searchParams.delete("error_description");
      history.replaceState({}, document.title, url.toString());
    }

    function readHashTokens(){
      const hash = (window.location.hash || "").replace(/^#/, "");
      const p = new URLSearchParams(hash);
      return {
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token"),
        expires_at: p.get("expires_at"),
        expires_in: p.get("expires_in")
      };
    }

    function decodeJwtPayload(jwt){
      try{
        const parts = jwt.split(".");
        if (parts.length < 2) return null;
        const b64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const json = decodeURIComponent(atob(b64).split("").map(c => "%" + c.charCodeAt(0).toString(16).padStart(2,"0")).join(""));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function saveSessionToStorage(access_token, refresh_token, expires_at, expires_in){
      const now = Math.floor(Date.now()/1000);
      const exp =
        expires_at ? Number(expires_at) :
        expires_in ? (now + Number(expires_in)) :
        (now + 3600);

      const storageKey = `sb-${SUPABASE_REF}-auth-token`;
      const sessionObj = {
        access_token,
        refresh_token,
        token_type: "bearer",
        expires_in: Math.max(0, exp - now),
        expires_at: exp,
        user: null
      };
      localStorage.setItem(storageKey, JSON.stringify(sessionObj));
    }

    function loadAccessTokenFromStorage(){
      const storageKey = `sb-${SUPABASE_REF}-auth-token`;
      const raw = localStorage.getItem(storageKey);
      if (!raw) return null;
      try{
        const obj = JSON.parse(raw);
        return obj?.access_token || null;
      }catch(e){ return null; }
    }

    function loadUserFromStorageToken(){
      const token = loadAccessTokenFromStorage();
      if (!token) return null;
      const payload = decodeJwtPayload(token);
      if (!payload?.sub) return null;
      return { id: payload.sub, email: payload.email || "" };
    }

    let supabaseClient = null;
    let currentUser = null;

    function buildClient(){
      const token = loadAccessTokenFromStorage();
      if (token){
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: window.localStorage },
          global: { headers: { Authorization: `Bearer ${token}` } }
        });
      } else {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false, storage: window.localStorage }
        });
      }
    }

    function renderAuth(){
      if (currentUser){
        authStatusEl.textContent = "Logged in ✅";
        logoutBtn.style.display = "inline-block";
      } else {
        authStatusEl.textContent = "Logged out";
        logoutBtn.style.display = "none";
      }
    }

    async function loadCampaigns(){
      campaignsStatus.textContent = "Loading campaigns…";
      campaignsStatus.classList.remove("error");

      let q = supabaseClient
        .from("campaigns")
        .select("id,title,donation_url,created_at,status,user_id")
        .order("created_at", { ascending: false })
        .limit(25);

      if (currentUser) q = q.eq("user_id", currentUser.id);
      else q = q.eq("status", "published");

      const { data, error } = await q;
      if (error){
        campaignsStatus.textContent = "Error: " + error.message;
        campaignsStatus.classList.add("error");
        campaignsBody.innerHTML = "";
        return;
      }

      if (!data || data.length === 0){
        campaignsStatus.textContent = currentUser ? "No campaigns yet." : "No published campaigns.";
        campaignsBody.innerHTML = "";
        return;
      }

      const base = baseUrl();
      campaignsBody.innerHTML = data.map(c => {
        const t = c.title || "(Untitled)";
        const d = c.donation_url ? `<a href="${c.donation_url}" target="_blank" rel="noopener noreferrer">Open</a>` : "—";
        const created = c.created_at ? new Date(c.created_at).toLocaleString() : "";
        const view = `${base}campaign.html?id=${encodeURIComponent(c.id)}`;
        return `<tr><td>${t}</td><td>${d}</td><td>${created}</td><td><a href="${view}">View</a></td></tr>`;
      }).join("");

      campaignsStatus.textContent = `Showing ${data.length} campaign(s).`;
    }

    async function refreshAll(){
      currentUser = loadUserFromStorageToken();
      buildClient();
      renderAuth();
      await loadCampaigns();
    }

    function importFromHashIfPresent(){
      const t = readHashTokens();
      if (t.access_token && t.refresh_token){
        saveSessionToStorage(t.access_token, t.refresh_token, t.expires_at, t.expires_in);
        cleanUrl();
      }
    }

    function start(){
      if (!window.__sbLoaded){
        authStatusEl.textContent = "Supabase JS failed to load (blocked).";
        return;
      }

      importFromHashIfPresent();
      refreshAll();

      loginBtn.addEventListener("click", async () => {
        const email = (emailEl.value || "").trim();
        if (!email){ alert("Type your email first."); return; }

        const redirectTo = `${baseUrl()}index.html?v=${Date.now()}`;

        authStatusEl.textContent = "Sending link…";
        const { error } = await supabaseClient.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: redirectTo }
        });

        if (error){
          authStatusEl.textContent = "Logged out";
          alert("Login error: " + error.message);
          return;
        }

        alert("Login email sent. Open the newest email and click the login link once.");
        authStatusEl.textContent = "Check your email (link sent)";
      });

      logoutBtn.addEventListener("click", async () => {
        const storageKey = `sb-${SUPABASE_REF}-auth-token`;
        localStorage.removeItem(storageKey);
        currentUser = null;
        buildClient();
        await refreshAll();
      });

      window.addEventListener("pageshow", async () => {
        await refreshAll();
      });

      document.getElementById("createForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        createStatus.textContent = "";
        createStatus.classList.remove("error");

        await refreshAll();

        if (!currentUser){
          createStatus.textContent = "Please log in first.";
          createStatus.classList.add("error");
          return;
        }

        const title = document.getElementById("title").value.trim();
        const donation_url = document.getElementById("donation_url").value.trim();
        const description = document.getElementById("description").value.trim() || null;

        createStatus.textContent = "Saving…";

        const { error } = await supabaseClient.from("campaigns").insert({
          user_id: currentUser.id,
          title,
          donation_url,
          description,
          status: "published"
        });

        if (error){
          createStatus.textContent = "Error: " + error.message;
          createStatus.classList.add("error");
          return;
        }

        createStatus.textContent = "Saved ✅";
        await loadCampaigns();
      });
    }

    setTimeout(start, 0);
  </script>
</body>
</html>
