<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SongRaise Lite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.55;
      color: #111827;
      background: #f9fafb;
    }
    a { color: inherit; text-decoration: none; }
    .wrapper { max-width: 1100px; margin: 0 auto; padding: 18px 16px 72px; }

    header {
      padding: 14px 0 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .logo { font-weight: 800; font-size: 1.25rem; }
    .logo span { color: #2563eb; }
    nav a {
      margin-left: 14px;
      font-size: 0.95rem;
      color: #4b5563;
    }
    nav a:hover { color: #111827; text-decoration: underline; }

    .section { padding: 22px 0; }
    .section h2 { font-size: 1.35rem; margin-bottom: 8px; }
    .lead { color: #4b5563; margin-bottom: 14px; max-width: 760px; }

    .btn {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.92rem;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary { background: #2563eb; color: #ffffff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-ghost { background: transparent; border: 1px solid #d1d5db; color: #111827; }
    .btn-ghost:hover { background: #e5e7eb; }

    .btn-small { padding: 7px 12px; font-size: 0.85rem; font-weight: 700; }

    .card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 16px 14px;
    }

    .field-label { display:block; font-size:0.85rem; margin-bottom:4px; color:#374151; font-weight: 700; }
    .field-input, .field-select, .field-textarea {
      width:100%;
      padding:10px;
      margin-bottom:12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-size:0.95rem;
      background: #fff;
    }
    .field-textarea { resize: vertical; min-height: 70px; }

    .auth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .status-text { font-size: 0.86rem; margin-top: 6px; color: #6b7280; }

    .demo-bar {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .demo-pill {
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #111827;
      color: #fff;
      padding: 4px 10px;
      border-radius: 999px;
    }
    .demo-bar label { font-size: 0.85rem; font-weight: 700; color: #374151; }

    table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; overflow: hidden; }
    thead tr { background: #f3f4f6; }
    th, td { text-align: left; padding: 10px 10px; border-bottom: 1px solid #e5e7eb; font-size: 0.92rem; vertical-align: top; }
    tbody tr:last-child td { border-bottom: none; }
    .muted { color: #6b7280; font-size: 0.86rem; }

    footer {
      margin-top: 26px;
      padding-top: 14px;
      border-top: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="logo">SongRaise<span>Lite</span></div>
      <nav>
        <a href="#account">Account</a>
        <a href="#create-song">Create</a>
        <a href="#my-campaigns">My Campaigns</a>
        <a href="#org-signup">Charity Signup</a>
      </nav>
    </header>

    <!-- DEMO BAR -->
    <div class="demo-bar">
      <span class="demo-pill">Demo Mode</span>

      <label style="display:flex; align-items:center; gap:8px;">
        <input id="demoToggle" type="checkbox" />
        Enable demo mode
      </label>

      <button id="loadDemoBtn" class="btn btn-ghost btn-small">Load demo campaign</button>

      <span id="demoStatus" class="muted"></span>
    </div>

    <!-- ACCOUNT -->
    <section class="section" id="account">
      <h2>Login or Create Your Account</h2>
      <p class="lead">Log in to attach campaigns to your account.</p>

      <p id="authStatusText" class="muted" style="margin-bottom:12px;">Not logged in.</p>

      <div class="auth-grid">
        <div class="card">
          <h3 style="font-size:1.05rem; margin-bottom:10px;">Log in</h3>
          <form id="loginForm">
            <label class="field-label" for="loginEmail">Email</label>
            <input id="loginEmail" type="email" class="field-input" required />

            <label class="field-label" for="loginPassword">Password</label>
            <input id="loginPassword" type="password" class="field-input" required />

            <button type="submit" class="btn btn-primary">Sign in</button>
            <div id="loginStatus" class="status-text"></div>
          </form>
        </div>

        <div class="card">
          <h3 style="font-size:1.05rem; margin-bottom:10px;">Create an account</h3>
          <form id="signupForm">
            <label class="field-label" for="signupName">Name</label>
            <input id="signupName" type="text" class="field-input" placeholder="Your name" />

            <label class="field-label" for="signupEmail">Email</label>
            <input id="signupEmail" type="email" class="field-input" required />

            <label class="field-label" for="signupPassword">Password</label>
            <input id="signupPassword" type="password" class="field-input" required />

            <button type="submit" class="btn btn-primary">Create account</button>
            <div id="signupStatus" class="status-text"></div>
          </form>
        </div>

        <div class="card">
          <h3 style="font-size:1.05rem; margin-bottom:10px;">Account</h3>
          <p style="font-size:0.95rem; margin-bottom:8px;">
            Email: <strong><span id="accountEmail">Not logged in</span></strong><br/>
            Org status: <strong><span id="accountOrgStatus">—</span></strong>
          </p>

          <form id="displayNameForm" style="margin-top:10px;">
            <label class="field-label" for="displayNameInput">Display name (optional)</label>
            <input id="displayNameInput" type="text" class="field-input" placeholder="How you want to appear" />
            <button type="submit" class="btn btn-ghost">Save name</button>
            <div id="displayNameStatus" class="status-text"></div>
          </form>

          <button id="logoutButton" class="btn btn-ghost" style="margin-top:12px;">Log out</button>
        </div>
      </div>
    </section>

    <!-- CREATE -->
    <section class="section" id="create-song">
      <h2>Create a Fundraising Song and Campaign</h2>
      <p class="lead">Upload an MP3 to store it in SongRaise and play it inside the campaign page.</p>

      <form id="createSongForm" class="card" style="max-width: 760px;">
        <label for="cause_category" class="field-label">Cause category (optional)</label>
        <input id="cause_category" class="field-input" placeholder="e.g., Neurological Disorders" />

        <label for="condition" class="field-label">Condition (optional)</label>
        <input id="condition" class="field-input" placeholder="e.g., Stroke" />

        <label for="emotion" class="field-label">Emotion</label>
        <select id="emotion" required class="field-select">
          <option value="Hopeful">Hopeful</option>
          <option value="Comforting">Comforting</option>
          <option value="Inspiring">Inspiring</option>
          <option value="Strong">Strong</option>
        </select>

        <label for="genre" class="field-label">Genre</label>
        <select id="genre" required class="field-select">
          <option value="Pop">Pop</option>
          <option value="Acoustic">Acoustic</option>
          <option value="Folk">Folk</option>
          <option value="Ballad">Ballad</option>
        </select>

        <label for="style" class="field-label">Artist style (optional)</label>
        <input id="style" class="field-input" placeholder="e.g., like Ed Sheeran" />

        <label for="donation_url" class="field-label">Donation page URL</label>
        <input id="donation_url" type="url" required class="field-input" placeholder="https://..." />

        <label for="campaign_title" class="field-label">Campaign title</label>
        <input id="campaign_title" required class="field-input" placeholder="e.g., You Are Not Alone" />

        <label for="campaign_description" class="field-label">Campaign description</label>
        <textarea id="campaign_description" rows="3" class="field-textarea" placeholder="Short description..."></textarea>

        <label for="audio_url" class="field-label">Audio URL (auto-filled after upload)</label>
        <input id="audio_url" type="url" class="field-input" placeholder="(optional)" />

        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px;">
          <input id="audio_file" type="file" accept="audio/*" style="font-size:0.88rem;">
          <button type="button" id="uploadAudioBtn" class="btn btn-primary btn-small">Upload MP3</button>
          <span id="uploadAudioStatus" class="muted"></span>
        </div>

        <input type="hidden" id="lyric_prompt" value="Write lyrics for a fundraising song." />

        <button type="submit" class="btn btn-primary">Create Song and Campaign</button>
        <div id="createSongStatus" class="status-text"></div>
      </form>
    </section>

    <!-- MY CAMPAIGNS -->
    <section class="section" id="my-campaigns">
      <h2>My Campaigns</h2>
      <p class="lead">Click “View” to open the shareable campaign page.</p>

      <div style="display:flex; flex-wrap:wrap; gap:14px; margin-bottom:12px;">
        <div class="card" style="padding:12px 12px; min-width: 170px;">
          <div style="font-size:0.85rem; color:#6b7280;">Campaigns</div>
          <div style="font-size:1.4rem; font-weight:900;" id="impactTotalCampaigns">0</div>
        </div>
        <div class="card" style="padding:12px 12px; min-width: 280px;">
          <div style="font-size:0.85rem; color:#6b7280;">Latest created</div>
          <div style="font-size:0.98rem; font-weight:800;" id="impactLatestCreated">—</div>
        </div>
      </div>

      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Donation</th>
              <th>Status</th>
              <th>Created</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="campaignsTableBody"></tbody>
        </table>
      </div>

      <p id="myCampaignsStatus" class="muted" style="margin-top:10px;">Loading campaigns…</p>
    </section>

    <!-- ORG SIGNUP -->
    <section class="section" id="org-signup">
      <h2>Charity / Nonprofit Signup</h2>
      <p class="lead">We review each signup to help prevent fraudulent profiles.</p>

      <form id="orgSignupForm" class="card" style="max-width: 760px;">
        <label class="field-label" for="org_name">Organization name</label>
        <input id="org_name" class="field-input" type="text" required />

        <label class="field-label" for="org_email">Organization email</label>
        <input id="org_email" class="field-input" type="email" required />

        <label class="field-label" for="org_country">Country</label>
        <input id="org_country" class="field-input" type="text" placeholder="e.g., Canada" />

        <label class="field-label" for="org_number">Nonprofit / charity registration number</label>
        <input id="org_number" class="field-input" type="text" required />

        <label class="field-label" for="org_website">Website (optional)</label>
        <input id="org_website" class="field-input" type="url" />

        <label class="field-label" for="org_mission">Mission / what you do</label>
        <textarea id="org_mission" class="field-textarea"></textarea>

        <button type="submit" class="btn btn-primary">Submit for review</button>
        <div id="orgSignupStatus" class="status-text"></div>
      </form>
    </section>

    <footer>
      <div>&copy; <span id="year"></span> SongRaise Lite</div>
      <div class="muted">Hosted on GitHub Pages</div>
    </footer>
  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /**************************************
     * SUPABASE INIT
     **************************************/
    const SUPABASE_URL = "https://jvvcxpjmdfeqjdmcemet.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dmN4cGptZGZlcWpkbWNlbWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1Nzc3NzYsImV4cCI6MjA3NzE1Mzc3Nn0.LPRIt10bLZYfoOCx7nD4U0PsCURB7YToq4VbByliFi4";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /**************************************
     * ELEMENTS
     **************************************/
    const authStatusText = document.getElementById("authStatusText");
    const accountEmailSpan = document.getElementById("accountEmail");
    const accountOrgStatusSpan = document.getElementById("accountOrgStatus");

    const loginForm = document.getElementById("loginForm");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const loginStatus = document.getElementById("loginStatus");

    const signupForm = document.getElementById("signupForm");
    const signupNameInput = document.getElementById("signupName");
    const signupEmailInput = document.getElementById("signupEmail");
    const signupPasswordInput = document.getElementById("signupPassword");
    const signupStatus = document.getElementById("signupStatus");

    const logoutButton = document.getElementById("logoutButton");

    const displayNameForm = document.getElementById("displayNameForm");
    const displayNameInput = document.getElementById("displayNameInput");
    const displayNameStatus = document.getElementById("displayNameStatus");

    const createSongForm = document.getElementById("createSongForm");
    const createSongStatus = document.getElementById("createSongStatus");

    const campaignsTableBody = document.getElementById("campaignsTableBody");
    const myCampaignsStatus = document.getElementById("myCampaignsStatus");
    const impactTotalCampaigns = document.getElementById("impactTotalCampaigns");
    const impactLatestCreated = document.getElementById("impactLatestCreated");

    const audioUrlInput = document.getElementById("audio_url");
    const audioFileInput = document.getElementById("audio_file");
    const uploadAudioBtn = document.getElementById("uploadAudioBtn");
    const uploadAudioStatus = document.getElementById("uploadAudioStatus");

    const orgSignupForm = document.getElementById("orgSignupForm");
    const orgSignupStatus = document.getElementById("orgSignupStatus");

    const demoToggle = document.getElementById("demoToggle");
    const loadDemoBtn = document.getElementById("loadDemoBtn");
    const demoStatus = document.getElementById("demoStatus");

    let currentUser = null;

    /**************************************
     * HELPERS
     **************************************/
    function formatDateTime(str) {
      if (!str) return "";
      const d = new Date(str);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString();
    }

    function clearCampaignsTable() {
      campaignsTableBody.innerHTML = "";
      myCampaignsStatus.textContent = "Log in to see your campaigns.";
      myCampaignsStatus.style.color = "#6b7280";
      impactTotalCampaigns.textContent = "0";
      impactLatestCreated.textContent = "—";
    }

    function updateAuthUI() {
      if (currentUser) {
        authStatusText.textContent = "Logged in.";
        accountEmailSpan.textContent = currentUser.email || "(no email)";
      } else {
        authStatusText.textContent = "Not logged in.";
        accountEmailSpan.textContent = "Not logged in";
        accountOrgStatusSpan.textContent = "—";
        displayNameInput.value = "";
      }
    }

    async function refreshUser() {
      const { data, error } = await supabaseClient.auth.getUser();
      if (error) {
        console.error(error);
        currentUser = null;
      } else {
        currentUser = data.user || null;
      }

      updateAuthUI();

      if (currentUser) {
        await loadDisplayName();
        await loadOrgStatus();
        await loadCampaigns();   // <-- IMPORTANT: uses the fixed View URL logic
      } else {
        clearCampaignsTable();
      }
    }

    /**************************************
     * AUTH: LOGIN / SIGNUP / LOGOUT
     **************************************/
    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        loginStatus.textContent = "Signing in...";
        loginStatus.style.color = "#6b7280";

        const email = loginEmailInput.value.trim();
        const password = loginPasswordInput.value;

        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

        if (error) {
          console.error(error);
          loginStatus.textContent = "Login error: " + error.message;
          loginStatus.style.color = "red";
          return;
        }

        loginStatus.textContent = "Signed in.";
        loginStatus.style.color = "green";
        await refreshUser();
      });
    }

    if (signupForm) {
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        signupStatus.textContent = "Creating account...";
        signupStatus.style.color = "#6b7280";

        const name = signupNameInput.value.trim();
        const email = signupEmailInput.value.trim();
        const password = signupPasswordInput.value;

        const { error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: { data: { full_name: name || null } }
        });

        if (error) {
          console.error(error);
          signupStatus.textContent = "Signup error: " + error.message;
          signupStatus.style.color = "red";
          return;
        }

        signupStatus.textContent = "Account created. You can log in now.";
        signupStatus.style.color = "green";
      });
    }

    if (logoutButton) {
      logoutButton.addEventListener("click", async () => {
        await supabaseClient.auth.signOut();
        currentUser = null;
        updateAuthUI();
        clearCampaignsTable();
      });
    }

    /**************************************
     * PROFILES: DISPLAY NAME
     **************************************/
    async function loadDisplayName() {
      if (!currentUser) return;

      const { data, error } = await supabaseClient
        .from("profiles")
        .select("display_name")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (error) {
        console.error("Load display_name error", error);
        return;
      }

      if (data && data.display_name) displayNameInput.value = data.display_name;
    }

    if (displayNameForm) {
      displayNameForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUser) {
          displayNameStatus.textContent = "Please log in first.";
          displayNameStatus.style.color = "red";
          return;
        }

        const name = displayNameInput.value.trim();
        displayNameStatus.textContent = "Saving...";
        displayNameStatus.style.color = "#6b7280";

        const { error } = await supabaseClient
          .from("profiles")
          .upsert({ id: currentUser.id, display_name: name }, { onConflict: "id" });

        if (error) {
          console.error(error);
          displayNameStatus.textContent = "Error saving name: " + error.message;
          displayNameStatus.style.color = "red";
          return;
        }

        displayNameStatus.textContent = "Saved.";
        displayNameStatus.style.color = "green";
      });
    }

    /**************************************
     * ORG STATUS + SIGNUP
     **************************************/
    async function loadOrgStatus() {
      if (!currentUser) return;

      const { data, error } = await supabaseClient
        .from("org_signups")
        .select("status, created_at")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error(error);
        accountOrgStatusSpan.textContent = "Error loading.";
        return;
      }

      if (!data) accountOrgStatusSpan.textContent = "No application yet.";
      else accountOrgStatusSpan.textContent = data.status || "pending";
    }

    if (orgSignupForm) {
      orgSignupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUser) {
          orgSignupStatus.textContent = "Please log in first.";
          orgSignupStatus.style.color = "red";
          return;
        }

        orgSignupStatus.textContent = "Submitting...";
        orgSignupStatus.style.color = "#6b7280";

        const payload = {
          user_id: currentUser.id,
          org_name: document.getElementById("org_name").value.trim(),
          org_email: document.getElementById("org_email").value.trim(),
          country: document.getElementById("org_country").value.trim() || null,
          nonprofit_number: document.getElementById("org_number").value.trim(),
          website: document.getElementById("org_website").value.trim() || null,
          mission: document.getElementById("org_mission").value.trim() || null,
          status: "pending"
        };

        const { error } = await supabaseClient.from("org_signups").insert(payload);

        if (error) {
          console.error(error);
          orgSignupStatus.textContent = "Error submitting: " + error.message;
          orgSignupStatus.style.color = "red";
          return;
        }

        orgSignupStatus.textContent = "Submitted. We will review your organization.";
        orgSignupStatus.style.color = "green";
        await loadOrgStatus();
      });
    }

    /**************************************
     * UPLOAD MP3 -> STORAGE (song-audio bucket)
     **************************************/
    if (uploadAudioBtn) {
      uploadAudioBtn.addEventListener("click", async () => {
        uploadAudioStatus.textContent = "";
        uploadAudioStatus.style.color = "#6b7280";

        const file = audioFileInput.files && audioFileInput.files[0];
        if (!file) {
          uploadAudioStatus.textContent = "Choose an audio file first.";
          uploadAudioStatus.style.color = "red";
          return;
        }
        if (!file.type.startsWith("audio/")) {
          uploadAudioStatus.textContent = "That file is not recognized as audio.";
          uploadAudioStatus.style.color = "red";
          return;
        }

        const { data: userData, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !userData?.user) {
          uploadAudioStatus.textContent = "Please sign in before uploading.";
          uploadAudioStatus.style.color = "red";
          return;
        }

        const userId = userData.user.id;
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
        const filePath = `${userId}/${timestamp}-${safeName}`;

        uploadAudioStatus.textContent = "Uploading…";

        const { error: uploadError } = await supabaseClient.storage
          .from("song-audio")
          .upload(filePath, file, { cacheControl: "3600", upsert: false });

        if (uploadError) {
          console.error(uploadError);
          uploadAudioStatus.textContent = "Upload failed: " + uploadError.message;
          uploadAudioStatus.style.color = "red";
          return;
        }

        const { data: publicData } = supabaseClient.storage
          .from("song-audio")
          .getPublicUrl(filePath);

        if (!publicData?.publicUrl) {
          uploadAudioStatus.textContent = "Uploaded, but could not get a public URL.";
          uploadAudioStatus.style.color = "red";
          return;
        }

        audioUrlInput.value = publicData.publicUrl;
        uploadAudioStatus.textContent = "Upload complete. Audio URL attached.";
        uploadAudioStatus.style.color = "green";
      });
    }

    /**************************************
     * FIXED: LOAD CAMPAIGNS + WORKING VIEW LINK (GitHub Pages-safe)
     **************************************/
    async function loadCampaigns() {
      if (!currentUser) {
        clearCampaignsTable();
        return;
      }

      myCampaignsStatus.textContent = "Loading campaigns…";
      myCampaignsStatus.style.color = "#6b7280";

      const { data, error } = await supabaseClient
        .from("campaigns")
        .select("id, title, donation_url, status, created_at")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        myCampaignsStatus.textContent = "Error loading campaigns: " + error.message;
        myCampaignsStatus.style.color = "red";
        return;
      }

      if (!data || data.length === 0) {
        campaignsTableBody.innerHTML = "";
        myCampaignsStatus.textContent = "No campaigns yet. Create your first one above.";
        myCampaignsStatus.style.color = "#6b7280";
        impactTotalCampaigns.textContent = "0";
        impactLatestCreated.textContent = "—";
        return;
      }

      // Build absolute base to campaign.html so it works on GitHub Pages subpaths
      const campaignBaseUrl = new URL("campaign.html", window.location.href).toString();

      campaignsTableBody.innerHTML = data.map((c) => {
        const safeTitle = c.title || "(No title)";
        const safeStatus = c.status || "draft";
        const created = formatDateTime(c.created_at);

        const donationCell = c.donation_url
          ? `<a href="${c.donation_url}" target="_blank" rel="noopener noreferrer" style="color:#2563eb; text-decoration:underline;">Open link</a>`
          : "—";

        // IMPORTANT: absolute URL for GitHub Pages
        const viewHref = `${campaignBaseUrl}?id=${encodeURIComponent(c.id)}`;

        const viewCell = `<a href="${viewHref}" style="color:#2563eb; text-decoration:underline; font-weight:800;">View</a>`;

        return `
          <tr>
            <td>${safeTitle}</td>
            <td>${donationCell}</td>
            <td style="text-transform:capitalize;">${safeStatus}</td>
            <td>${created}</td>
            <td>${viewCell}</td>
          </tr>
        `;
      }).join("");

      myCampaignsStatus.textContent = `Showing ${data.length} campaign(s).`;
      myCampaignsStatus.style.color = "#6b7280";

      impactTotalCampaigns.textContent = String(data.length);
      impactLatestCreated.textContent = data[0]?.created_at ? formatDateTime(data[0].created_at) : "—";
    }

    /**************************************
     * CREATE SONG + CAMPAIGN
     **************************************/
    if (createSongForm) {
      createSongForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentUser) {
          createSongStatus.textContent = "Please log in first.";
          createSongStatus.style.color = "red";
          return;
        }

        createSongStatus.textContent = "Saving…";
        createSongStatus.style.color = "#6b7280";

        const causeCategory = document.getElementById("cause_category").value.trim();
        const condition = document.getElementById("condition").value.trim();
        const emotion = document.getElementById("emotion").value;
        const genre = document.getElementById("genre").value;
        const style = document.getElementById("style").value.trim();
        const donationUrl = document.getElementById("donation_url").value.trim();
        const campaignTitle = document.getElementById("campaign_title").value.trim();
        const campaignDescription = document.getElementById("campaign_description").value.trim();
        const audioUrl = document.getElementById("audio_url").value.trim();
        const lyricPrompt = document.getElementById("lyric_prompt").value || "Write lyrics for a fundraising song.";

        if (!donationUrl || !campaignTitle) {
          createSongStatus.textContent = "Donation URL + campaign title are required.";
          createSongStatus.style.color = "red";
          return;
        }

        // Insert song
        const { data: songData, error: songError } = await supabaseClient
          .from("songs")
          .insert({
            cause_category: causeCategory || null,
            condition: condition || null,
            emotion,
            genre,
            style: style || null,
            lyric_prompt: lyricPrompt,
            audio_url: audioUrl || null,
            status: "draft"
          })
          .select()
          .single();

        if (songError) {
          console.error(songError);
          createSongStatus.textContent = "Error saving song: " + songError.message;
          createSongStatus.style.color = "red";
          return;
        }

        // Slug (avoid unique collisions with timestamp)
        const baseSlug = campaignTitle
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "")
          .slice(0, 60);

        const slug = `${baseSlug}-${Date.now()}`;

        // Insert campaign
        const { error: campaignError } = await supabaseClient
          .from("campaigns")
          .insert({
            user_id: currentUser.id,
            song_id: songData.id,
            title: campaignTitle,
            description: campaignDescription || null,
            donation_url: donationUrl,
            campaign_slug: slug,
            status: "draft"
          });

        if (campaignError) {
          console.error(campaignError);
          createSongStatus.textContent = "Error saving campaign: " + campaignError.message;
          createSongStatus.style.color = "red";
          return;
        }

        createSongStatus.textContent = "Saved! Song + campaign created.";
        createSongStatus.style.color = "green";

        createSongForm.reset();
        audioUrlInput.value = "";
        uploadAudioStatus.textContent = "";

        await loadCampaigns();
      });
    }

    /**************************************
     * DEMO MODE
     **************************************/
    function setDemo(enabled) {
      localStorage.setItem("songraise_demo_mode", enabled ? "1" : "0");
      demoStatus.textContent = enabled ? "Demo mode is ON" : "Demo mode is OFF";
    }

    function isDemoEnabled() {
      return localStorage.getItem("songraise_demo_mode") === "1";
    }

    if (demoToggle) {
      demoToggle.checked = isDemoEnabled();
      setDemo(demoToggle.checked);

      demoToggle.addEventListener("change", () => {
        setDemo(demoToggle.checked);
      });
    }

    if (loadDemoBtn) {
      loadDemoBtn.addEventListener("click", () => {
        // Simple demo autofill
        document.getElementById("cause_category").value = "Neurological Disorders";
        document.getElementById("condition").value = "Stroke";
        document.getElementById("emotion").value = "Hopeful";
        document.getElementById("genre").value = "Pop";
        document.getElementById("style").value = "uplifting modern pop";
        document.getElementById("donation_url").value = "https://example.com/donate";
        document.getElementById("campaign_title").value = "You Are Not Alone";
        document.getElementById("campaign_description").value = "A demo campaign to show how SongRaise works.";

        // Your demo MP3 URL (wired)
        document.getElementById("audio_url").value =
          "https://jvvcxpjmdfeqjdmcemet.supabase.co/storage/v1/object/public/song-audio/Untitled%20folder/Well%20I%20knew%20I%20felt%20a%20tingle%20when%20my%20head%20(1).mp3";

        demoStatus.textContent = "Demo fields filled. Click “Create Song and Campaign”.";
      });
    }

    /**************************************
     * INITIAL LOAD
     **************************************/
    refreshUser();
  </script>
</body>
</html>
